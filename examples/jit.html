<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Pyro Tutorials 1.8.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example: distributed training via Horovod" href="svi_horovod.html" />
    <link rel="prev" title="&lt;no title&gt;" href="workflow.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.8.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Practical Pyro and PyTorch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="svi_horovod.html">Example: distributed training via Horovod</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep Generative Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cevae.html">Example: Causal Effect VAE</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_gamma.html">Example: Sparse Gamma Deep Exponential Family</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Discrete Latent Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="toy_mixture_model_discrete_enumeration.html">Example: Toy Mixture Model With Discrete Enumeration</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm.html">Example: Hidden Markov Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="capture_recapture.html">Example: Capture-Recapture Models (CJS Models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_hmm.html">Example: hierarchical mixed-effect hidden Markov models</a></li>
<li class="toctree-l1"><a class="reference internal" href="einsum.html">Example: Discrete Factor Graph Inference with Plated Einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="lda.html">Example: Amortized Latent Dirichlet Allocation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Customizing Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="neutra.html">Example: Neural MCMC with NeuTraReparam</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_regression.html">Example: Sparse Bayesian Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoname_examples.html">Example: reducing boilerplate with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.autoname</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Time Series</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="forecast_simple.html">Multivariate Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries.html">Example: Gaussian Process Time Series Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Gaussian Processes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dkl.html">Example: Deep Kernel Learning</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Epidemiology</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="epi_sir.html">Example: Univariate epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="epi_regional.html">Example: Regional epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="sir_hmc.html">Example: Epidemiological inference via HMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Biological sequences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mue_profile.html">Example: Constant + MuE (Profile HMM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mue_factor.html">Example: Probabilistic PCA + MuE (FactorMuE)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Inference Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="baseball.html">Example: analyzing baseball stats with MCMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcmc.html">Example: Inference with Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="lkj.html">Example: MCMC with an LKJ prior over covariances</a></li>
<li class="toctree-l1"><a class="reference internal" href="smcfilter.html">Example: Sequential Monte Carlo Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclined_plane.html">Example: importance sampling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Understanding Pyro's Internals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="minipyro.html">Mini-Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm_funsor.html">Example: hidden Markov models with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.funsor</span></code> and <code class="docutils literal notranslate"><span class="pre">pyroapi</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pyro Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/jit.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<dl>
<dt>{</dt><dd><dl>
<dt>“cells”: [</dt><dd><dl>
<dt>{</dt><dd><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Using the PyTorch JIT Compiler with Pyron”,
“n”,
“This tutorial shows how to use the PyTorch [jit compiler](<a class="reference external" href="https://pytorch.org/docs/master/jit.html">https://pytorch.org/docs/master/jit.html</a>) in Pyro models.n”,
“n”,
“#### Summary:n”,
“- You can use compiled functions in Pyro models.n”,
“- You cannot use pyro primitives inside compiled functions.n”,
“- If your model has static structure, you can use a <cite>Jit*</cite> version of an <cite>ELBO</cite> algorithm, e.g.n”,
”  <code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;</span>&#160; <span class="pre">-</span> <span class="pre">Trace_ELBO()\n&quot;,</span>
<span class="pre">&quot;</span>&#160; <span class="pre">+</span> <span class="pre">JitTrace_ELBO()\n&quot;,</span>
<span class="pre">&quot;</span>&#160; <span class="pre">`</span></code>n”,
“- The [HMC](<a class="reference external" href="http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.HMC">http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.HMC</a>) and [NUTS](<a class="reference external" href="http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.NUTS">http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.NUTS</a>) classes accept <cite>jit_compile=True</cite> kwarg.n”,
“- Models should input all tensors as <cite>*args</cite> and all non-tensors as <cite>**kwargs</cite>.n”,
“- Each different value of <cite>**kwargs</cite> triggers a separate compilation.n”,
“- Use <cite>**kwargs</cite> to specify all variation in structure (e.g. time series length).n”,
“- To ignore jit warnings in safe code blocks, use <cite>with pyro.util.ignore_jit_warnings():</cite>.n”,
“- To ignore all jit warnings in <cite>HMC</cite> or <cite>NUTS</cite>, pass <cite>ignore_jit_warnings=True</cite>.n”,
“n”,
“#### Table of contentsn”,
“- [Introduction](#Introduction)n”,
“- [A simple model](#A-simple-model)n”,
“- [Varying structure](#Varying-structure)”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 1,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“import osn”,
“import torchn”,
“import pyron”,
“import pyro.distributions as distn”,
“from torch.distributions import constraintsn”,
“from pyro import poutinen”,
“from pyro.distributions.util import broadcast_shapen”,
“from pyro.infer import Trace_ELBO, JitTrace_ELBO, TraceEnum_ELBO, JitTraceEnum_ELBO, SVIn”,
“from pyro.infer.mcmc import MCMC, NUTSn”,
“from pyro.infer.autoguide import AutoDiagonalNormaln”,
“from pyro.optim import Adamn”,
“n”,
“smoke_test = (‘CI’ in os.environ)n”,
“assert pyro.__version__.startswith(‘1.8.1’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“n”,
“## Introductionn”,
“n”,
“PyTorch 1.0 includes a [jit compiler](<a class="reference external" href="https://pytorch.org/docs/master/jit.html">https://pytorch.org/docs/master/jit.html</a>) to speed up models. You can think of compilation as a &quot;static mode&quot;, whereas PyTorch usually operates in &quot;eager mode&quot;.n”,
“n”,
“Pyro supports the jit compiler in two ways. First you can use compiled functions inside Pyro models (but those functions cannot contain Pyro primitives). Second, you can use Pyro’s jit inference algorithms to compile entire inference steps; in static models this can reduce the Python overhead of Pyro models and speed up inference.n”,
“n”,
“The rest of this tutorial focuses on Pyro’s jitted inference algorithms: [JitTrace_ELBO](<a class="reference external" href="http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.trace_elbo.JitTrace_ELBO">http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.trace_elbo.JitTrace_ELBO</a>), [JitTraceGraph_ELBO](<a class="reference external" href="http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.tracegraph_elbo.JitTraceGraph_ELBO">http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.tracegraph_elbo.JitTraceGraph_ELBO</a>), [JitTraceEnum_ELBO](<a class="reference external" href="http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.traceenum_elbo.JitTraceEnum_ELBO">http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.traceenum_elbo.JitTraceEnum_ELBO</a>), [JitMeanField_ELBO](<a class="reference external" href="http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.trace_mean_field_elbo.JitTraceMeanField_ELBO">http://docs.pyro.ai/en/dev/inference_algos.html#pyro.infer.trace_mean_field_elbo.JitTraceMeanField_ELBO</a>), [HMC(jit_compile=True)](<a class="reference external" href="http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.HMC">http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.HMC</a>), and [NUTS(jit_compile=True)](<a class="reference external" href="http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.NUTS">http://docs.pyro.ai/en/dev/mcmc.html#pyro.infer.mcmc.NUTS</a>). For further reading, see the [examples/](<a class="reference external" href="https://github.com/pyro-ppl/pyro/tree/dev/examples">https://github.com/pyro-ppl/pyro/tree/dev/examples</a>) directory, where most examples include a <cite>–jit</cite> option to run in compiled mode.n”,
“n”,
“## A simple modeln”,
“n”,
“Let’s start with a simple Gaussian model and an [autoguide](<a class="reference external" href="http://docs.pyro.ai/en/dev/infer.autoguide.html">http://docs.pyro.ai/en/dev/infer.autoguide.html</a>).”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 2,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“def model(data):n”,
”    loc = pyro.sample(&quot;loc&quot;, dist.Normal(0., 10.))n”,
”    scale = pyro.sample(&quot;scale&quot;, dist.LogNormal(0., 3.))n”,
”    with pyro.plate(&quot;data&quot;, data.size(0)):n”,
”        pyro.sample(&quot;obs&quot;, dist.Normal(loc, scale), obs=data)n”,
“n”,
“guide = AutoDiagonalNormal(model)n”,
“n”,
“data = dist.Normal(0.5, 2.).sample((100,))”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“First let’s run as usual with an SVI object and <cite>Trace_ELBO</cite>.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 3,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“CPU times: user 2.71 s, sys: 31.4 ms, total: 2.74 sn”,
“Wall time: 2.76 sn”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“%%timen”,
“pyro.clear_param_store()n”,
“elbo = Trace_ELBO()n”,
“svi = SVI(model, guide, Adam({‘lr’: 0.01}), elbo)n”,
“for i in range(2 if smoke_test else 1000):n”,
”    svi.step(data)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Next to run with a jit compiled inference, we simply replacen”,
“<code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;-</span> <span class="pre">elbo</span> <span class="pre">=</span> <span class="pre">Trace_ELBO()\n&quot;,</span>
<span class="pre">&quot;+</span> <span class="pre">elbo</span> <span class="pre">=</span> <span class="pre">JitTrace_ELBO()\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“Also note that the <cite>AutoDiagonalNormal</cite> guide behaves a little differently on its first invocation (it runs the model to produce a prototype trace), and we don’t want to record this warmup behavior when compiling. Thus we call the <cite>guide(data)</cite> once to initialize, then run the compiled SVI,”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 4,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“CPU times: user 1.1 s, sys: 30.4 ms, total: 1.13 sn”,
“Wall time: 1.16 sn”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“%%timen”,
“pyro.clear_param_store()n”,
“n”,
“guide(data)  # Do any lazy initialization before compiling.n”,
“n”,
“elbo = JitTrace_ELBO()n”,
“svi = SVI(model, guide, Adam({‘lr’: 0.01}), elbo)n”,
“for i in range(2 if smoke_test else 1000):n”,
”    svi.step(data)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Notice that we have a more than 2x speedup for this small model.n”,
“n”,
“Let us now use the same model, but we will instead use MCMC to generate samples from the model’s posterior. We will use the No-U-Turn(NUTS) sampler.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 5,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><dl>
<dt>“data”: {</dt><dd><dl class="simple">
<dt>“application/vnd.jupyter.widget-view+json”: {</dt><dd><p>“model_id”: “3dc474967f304f56a22df195ce1ed06f”,
“version_major”: 2,
“version_minor”: 0</p>
</dd>
</dl>
<p>},
“text/plain”: [</p>
<blockquote>
<div><p>“HBox(children=(IntProgress(value=0, description=’Warmup’, style=ProgressStyle(description_width=’initial’)), H…”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
“metadata”: {},
“output_type”: “display_data”</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“n”,
“CPU times: user 4.61 s, sys: 101 ms, total: 4.71 sn”,
“Wall time: 4.7 sn”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“%%timen”,
“nuts_kernel = NUTS(model)n”,
“pyro.set_rng_seed(1)n”,
“mcmc_run = MCMC(nuts_kernel, num_samples=100).run(data)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“We can compile the potential energy computation in NUTS using the <cite>jit_compile=True</cite> argument to the NUTS kernel. We also silence JIT warnings due to the presence of tensor constants in the model by using <cite>ignore_jit_warnings=True</cite>.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 6,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><dl>
<dt>“data”: {</dt><dd><dl class="simple">
<dt>“application/vnd.jupyter.widget-view+json”: {</dt><dd><p>“model_id”: “134dac15856941dfaf427a9e6089f7e3”,
“version_major”: 2,
“version_minor”: 0</p>
</dd>
</dl>
<p>},
“text/plain”: [</p>
<blockquote>
<div><p>“HBox(children=(IntProgress(value=0, description=’Warmup’, style=ProgressStyle(description_width=’initial’)), H…”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
“metadata”: {},
“output_type”: “display_data”</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“n”,
“CPU times: user 2.04 s, sys: 74.1 ms, total: 2.11 sn”,
“Wall time: 2.09 sn”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“%%timen”,
“nuts_kernel = NUTS(model, jit_compile=True, ignore_jit_warnings=True)n”,
“pyro.set_rng_seed(1)n”,
“mcmc_run = MCMC(nuts_kernel, num_samples=100).run(data)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“We notice a significant increase in sampling throughput when JIT compilation is enabled.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## Varying structuren”,
“n”,
“Time series models often run on datasets of multiple time series with different lengths. To accomodate varying structure like this, Pyro requires models to separate all model inputs into tensors and non-tensors.$^\dagger$n”,
“n”,
“- Non-tensor inputs should be passed as <cite>**kwargs</cite> to the model and guide. These can determine model structure, so that a model is compiled for each value of the passed <cite>**kwargs</cite>.n”,
“- Tensor inputs should be passed as <cite>*args</cite>. These must not determine model structure. However <cite>len(args)</cite> may determine model structure (as is used e.g. in semisupervised models).n”,
“n”,
“To illustrate this with a time series model, we will pass in a sequence of observations as a tensor <cite>arg</cite> and the sequence length as a non-tensor <cite>kwarg</cite>:”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 5,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“def model(sequence, num_sequences, length, state_dim=16):n”,
”    # This is a Gaussian HMM model.n”,
”    with pyro.plate(&quot;states&quot;, state_dim):n”,
”        trans = pyro.sample(&quot;trans&quot;, dist.Dirichlet(0.5 * torch.ones(state_dim)))n”,
”        emit_loc = pyro.sample(&quot;emit_loc&quot;, dist.Normal(0., 10.))n”,
”    emit_scale = pyro.sample(&quot;emit_scale&quot;, dist.LogNormal(0., 3.))n”,
“n”,
”    # We’re doing manual data subsampling, so we need to scale to actual data size.n”,
”    with poutine.scale(scale=num_sequences):n”,
”        # We’ll use enumeration inference over the hidden x.n”,
”        x = 0n”,
”        for t in pyro.markov(range(length)):n”,
”            x = pyro.sample(&quot;x_{}&quot;.format(t), dist.Categorical(trans[x]),n”,
”                            infer={&quot;enumerate&quot;: &quot;parallel&quot;})n”,
”            pyro.sample(&quot;y_{}&quot;.format(t), dist.Normal(emit_loc[x], emit_scale),n”,
”                        obs=sequence[t])n”,
“n”,
“guide = AutoDiagonalNormal(poutine.block(model, expose=[&quot;trans&quot;, &quot;emit_scale&quot;, &quot;emit_loc&quot;]))n”,
“n”,
“# This is fake data of different lengths.n”,
“lengths = [24] * 50 + [48] * 20 + [72] * 5n”,
“sequences = [torch.randn(length) for length in lengths]”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Now lets’ run SVI as usual.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 6,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“CPU times: user 52.4 s, sys: 270 ms, total: 52.7 sn”,
“Wall time: 52.8 sn”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“%%timen”,
“pyro.clear_param_store()n”,
“elbo = TraceEnum_ELBO(max_plate_nesting=1)n”,
“svi = SVI(model, guide, Adam({‘lr’: 0.01}), elbo)n”,
“for i in range(1 if smoke_test else 10):n”,
”    for sequence in sequences:n”,
”        svi.step(sequence,                                            # tensor argsn”,
”                 num_sequences=len(sequences), length=len(sequence))  # non-tensor args”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Again we’ll simply swap in a <cite>Jit*</cite> implementationn”,
“<code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;-</span> <span class="pre">elbo</span> <span class="pre">=</span> <span class="pre">TraceEnum_ELBO(max_plate_nesting=1)\n&quot;,</span>
<span class="pre">&quot;+</span> <span class="pre">elbo</span> <span class="pre">=</span> <span class="pre">JitTraceEnum_ELBO(max_plate_nesting=1)\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“Note that we are manually specifying the <cite>max_plate_nesting</cite> arg. Usually Pyro can figure this out automatically by running the model once on the first invocation; however to avoid this extra work when we run the compiler on the first step, we pass this in manually.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 7,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“CPU times: user 21.9 s, sys: 201 ms, total: 22.1 sn”,
“Wall time: 22.2 sn”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“%%timen”,
“pyro.clear_param_store()n”,
“n”,
“# Do any lazy initialization before compiling.n”,
“guide(sequences[0], num_sequences=len(sequences), length=len(sequences[0]))n”,
“n”,
“elbo = JitTraceEnum_ELBO(max_plate_nesting=1)n”,
“svi = SVI(model, guide, Adam({‘lr’: 0.01}), elbo)n”,
“for i in range(1 if smoke_test else 10):n”,
”    for sequence in sequences:n”,
”        svi.step(sequence,                                            # tensor argsn”,
”                 num_sequences=len(sequences), length=len(sequence))  # non-tensor args”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Again we see more than 2x speedup. Note that since there were three different sequence lengths, compilation was triggered three times.n”,
“n”,
“$^\dagger$ Note this section is only valid for SVI, and HMC/NUTS assume fixed model arguments.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>],
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“kernelspec”: {</dt><dd><p>“display_name”: “Python 3”,
“language”: “python”,
“name”: “python3”</p>
</dd>
</dl>
<p>},
“language_info”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“codemirror_mode”: {</dt><dd><p>“name”: “ipython”,
“version”: 3</p>
</dd>
</dl>
<p>},
“file_extension”: “.py”,
“mimetype”: “text/x-python”,
“name”: “python”,
“nbconvert_exporter”: “python”,
“pygments_lexer”: “ipython3”,
“version”: “3.6.10”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>},
“nbformat”: 4,
“nbformat_minor”: 2</p>
</dd>
</dl>
<p>}</p>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="workflow.html" class="btn btn-neutral float-left" title="&lt;no title&gt;" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="svi_horovod.html" class="btn btn-neutral float-right" title="Example: distributed training via Horovod" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Pyro Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>