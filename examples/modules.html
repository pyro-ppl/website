<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modules in Pyro &mdash; Pyro Tutorials 1.8.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="High-dimensional Bayesian workflow, with applications to SARS-CoV-2 strains" href="workflow.html" />
    <link rel="prev" title="Tensor shapes in Pyro" href="tensor_shapes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.8.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introductory Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro_long.html">Introduction to Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_rendering.html">Automatic rendering of Pyro models</a></li>
<li class="toctree-l1"><a class="reference internal" href="svi_part_i.html">SVI Part I: An Introduction to Stochastic Variational Inference in Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="svi_part_ii.html">SVI Part II: Conditional Independence, Subsampling, and Amortization</a></li>
<li class="toctree-l1"><a class="reference internal" href="svi_part_iii.html">SVI Part III: ELBO Gradient Estimators</a></li>
<li class="toctree-l1"><a class="reference internal" href="svi_part_iv.html">SVI Part IV: Tips and Tricks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Practical Pyro and PyTorch</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bayesian_regression.html">Bayesian Regression - Introduction (Part 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_regression_ii.html">Bayesian Regression - Inference Algorithms (Part 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="tensor_shapes.html">Tensor shapes in Pyro</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Modules in Pyro</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Summary:">Summary:</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Table-of-Contents">Table of Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#How-PyroModule-works">How <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> works</a></li>
<li class="toctree-l3"><a class="reference internal" href="#How-to-create-a-PyroModule">How to create a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#How-effects-work">How effects work</a></li>
<li class="toctree-l3"><a class="reference internal" href="#How-to-constrain-parameters">How to constrain parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#How-to-make-a-PyroModule-Bayesian">How to make a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> Bayesian</a></li>
<li class="toctree-l3"><a class="reference internal" href="#⚠-Caution:-accessing-attributes-inside-plates">⚠ Caution: accessing attributes inside plates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#How-to-create-a-complex-nested-PyroModule">How to create a complex nested <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#How-naming-works">How naming works</a></li>
<li class="toctree-l3"><a class="reference internal" href="#⚠-Caution:-avoiding-duplicate-names">⚠ Caution: avoiding duplicate names</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workflow.html">High-dimensional Bayesian workflow, with applications to SARS-CoV-2 strains</a></li>
<li class="toctree-l1"><a class="reference internal" href="jit.html">Using the PyTorch JIT Compiler with Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="svi_horovod.html">Example: distributed training via Horovod</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep Generative Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="vae.html">Variational Autoencoders</a></li>
<li class="toctree-l1"><a class="reference internal" href="ss-vae.html">The Semi-Supervised VAE</a></li>
<li class="toctree-l1"><a class="reference internal" href="cvae.html">Conditional Variational Auto-encoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="normalizing_flows_i.html">Normalizing Flows - Introduction (Part 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dmm.html">Deep Markov Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="air.html">Attend Infer Repeat</a></li>
<li class="toctree-l1"><a class="reference internal" href="cevae.html">Example: Causal Effect VAE</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_gamma.html">Example: Sparse Gamma Deep Exponential Family</a></li>
<li class="toctree-l1"><a class="reference internal" href="prodlda.html">Probabilistic Topic Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="scanvi.html"><em>scANVI: Deep Generative Modeling for Single Cell Data with Pyro</em></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Discrete Latent Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="enumeration.html">Inference with Discrete Latent Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="gmm.html">Gaussian Mixture Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="dirichlet_process_mixture.html">Dirichlet Process Mixture Models in Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="toy_mixture_model_discrete_enumeration.html">Example: Toy Mixture Model With Discrete Enumeration</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm.html">Example: Hidden Markov Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="capture_recapture.html">Example: Capture-Recapture Models (CJS Models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_hmm.html">Example: hierarchical mixed-effect hidden Markov models</a></li>
<li class="toctree-l1"><a class="reference internal" href="einsum.html">Example: Discrete Factor Graph Inference with Plated Einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="lda.html">Example: Amortized Latent Dirichlet Allocation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Customizing Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mle_map.html">MLE and MAP Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mle_map.html#Doing-the-same-thing-with-AutoGuides">Doing the same thing with AutoGuides</a></li>
<li class="toctree-l1"><a class="reference internal" href="easyguide.html">Writing guides using EasyGuide</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_objectives.html">Custom SVI Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="boosting_bbvi.html">Boosting Black Box Variational Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="neutra.html">Example: Neural MCMC with NeuTraReparam</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_regression.html">Example: Sparse Bayesian Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoname_examples.html">Example: reducing boilerplate with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.autoname</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Time Series</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="forecasting_i.html">Forecasting I: univariate, heavy tailed</a></li>
<li class="toctree-l1"><a class="reference internal" href="forecasting_ii.html">Forecasting II: state space models</a></li>
<li class="toctree-l1"><a class="reference internal" href="forecasting_iii.html">Forecasting III: hierarchical models</a></li>
<li class="toctree-l1"><a class="reference internal" href="forecasting_dlm.html">Forecasting with Dynamic Linear Model (DLM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="stable.html">Levy Stable models of Stochastic Volatility</a></li>
<li class="toctree-l1"><a class="reference internal" href="forecast_simple.html">Multivariate Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries.html">Example: Gaussian Process Time Series Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Gaussian Processes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="gp.html">Gaussian Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="gplvm.html">Gaussian Process Latent Variable Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="bo.html">Bayesian Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="dkl.html">Example: Deep Kernel Learning</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Epidemiology</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="epi_intro.html">Epidemiological models: Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="epi_sir.html">Example: Univariate epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="epi_regional.html">Example: Regional epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="sir_hmc.html">Example: Epidemiological inference via HMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="logistic-growth.html">Logistic growth models of SARS-CoV-2 lineage proportions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Biological sequences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mue_profile.html">Example: Constant + MuE (Profile HMM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mue_factor.html">Example: Probabilistic PCA + MuE (FactorMuE)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Experimental Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="working_memory.html">Designing Adaptive Experiments to Study Working Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="elections.html">Predicting the outcome of a US presidential election using Bayesian optimal experimental design</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Object Tracking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tracking_1d.html">Tracking an Unknown Number of Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="ekf.html">Kalman Filter</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Inference Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="baseball.html">Example: analyzing baseball stats with MCMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcmc.html">Example: Inference with Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="lkj.html">Example: MCMC with an LKJ prior over covariances</a></li>
<li class="toctree-l1"><a class="reference internal" href="csis.html">Compiled Sequential Importance Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="smcfilter.html">Example: Sequential Monte Carlo Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclined_plane.html">Example: importance sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="RSA-implicature.html">The Rational Speech Act framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="RSA-hyperbole.html">Understanding Hyperbole using RSA</a></li>
<li class="toctree-l1"><a class="reference internal" href="predictive_deterministic.html">Example: Utilizing Predictive and Deterministic with MCMC and SVI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Understanding Pyro's Internals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="minipyro.html">Mini-Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="effect_handlers.html">Poutine: A Guide to Programming with Effect Handlers in Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib_funsor_intro_i.html"><code class="docutils literal notranslate"><span class="pre">pyro.contrib.funsor</span></code>, a new backend for Pyro - New primitives (Part 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib_funsor_intro_ii.html"><code class="docutils literal notranslate"><span class="pre">pyro.contrib.funsor</span></code>, a new backend for Pyro - Building inference algorithms (Part 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm_funsor.html">Example: hidden Markov models with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.funsor</span></code> and <code class="docutils literal notranslate"><span class="pre">pyroapi</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deprecated</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro_part_i.html">(DEPRECATED) An Introduction to Models in Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro_part_ii.html">(DEPRECATED) An Introduction to Inference in Pyro</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pyro Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Modules in Pyro</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/modules.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Modules-in-Pyro">
<h1>Modules in Pyro<a class="headerlink" href="#Modules-in-Pyro" title="Permalink to this headline">¶</a></h1>
<p>This tutorial introduces <a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule">PyroModule</a>, Pyro’s Bayesian extension of PyTorch’s <a class="reference external" href="https://pytorch.org/docs/stable/nn.html#torch.nn.Module">nn.Module</a> class. Before starting you should understand the basics of Pyro <a class="reference external" href="http://pyro.ai/examples/intro_long.html">models and inference</a>, understand the two primitives <a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.sample">pyro.sample()</a> and
<a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.param">pyro.param()</a>, and understand the basics of Pyro’s <a class="reference external" href="http://pyro.ai/examples/effect_handlers.html">effect handlers</a> (e.g. by browsing <a class="reference external" href="https://github.com/pyro-ppl/pyro/blob/dev/pyro/contrib/minipyro.py">minipyro.py</a>).</p>
<section id="Summary:">
<h2>Summary:<a class="headerlink" href="#Summary:" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule">PyroModule</a>s are like <a class="reference external" href="https://pytorch.org/docs/stable/nn.html#torch.nn.Module">nn.Module</a>s but allow Pyro effects for sampling and constraints.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> is a mixin subclass of <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> that overrides attribute access (e.g. <code class="docutils literal notranslate"><span class="pre">.__getattr__()</span></code>).</p></li>
<li><p>There are three different ways to create a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>:</p>
<ul>
<li><p>create a new subclass: <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">MyModule(PyroModule):</span> <span class="pre">...</span></code>,</p></li>
<li><p>Pyro-ize an existing class: <code class="docutils literal notranslate"><span class="pre">MyModule</span> <span class="pre">=</span> <span class="pre">PyroModule[OtherModule]</span></code>, or</p></li>
<li><p>Pyro-ize an existing <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> instance in-place: <code class="docutils literal notranslate"><span class="pre">to_pyro_module_(my_module)</span></code>.</p></li>
</ul>
</li>
<li><p>Usual <code class="docutils literal notranslate"><span class="pre">nn.Parameter</span></code> attributes of a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> become Pyro parameters.</p></li>
<li><p>Parameters of a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> synchronize with Pyro’s global param store.</p></li>
<li><p>You can add constrained parameters by creating <a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroParam">PyroParam</a> objects.</p></li>
<li><p>You can add stochastic attributes by creating <a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroSample">PyroSample</a> objects.</p></li>
<li><p>Parameters and stochastic attributes are named automatically (no string required).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PyroSample</span></code> attributes are sampled once per <code class="docutils literal notranslate"><span class="pre">.__call__()</span></code> of the outermost <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>.</p></li>
<li><p>To enable Pyro effects on methods other than <code class="docutils literal notranslate"><span class="pre">.__call__()</span></code>, decorate them with &#64;<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.pyro_method">pyro_method</a>.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> model may contain <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> attributes.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> model may contain at most one <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> attribute (see <a class="reference external" href="#Caution-avoiding-duplicate-names">naming section</a>).</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> may contain both a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> model and <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> guide (e.g. <a class="reference external" href="http://docs.pyro.ai/en/stable/inference_algos.html#pyro.infer.predictive.Predictive">Predictive</a>).</p></li>
</ul>
</section>
<section id="Table-of-Contents">
<h2>Table of Contents<a class="headerlink" href="#Table-of-Contents" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#How-PyroModule-works">How PyroModule works</a></p></li>
<li><p><a class="reference external" href="#How-to-create-a-PyroModule">How to create a PyroModule</a></p></li>
<li><p><a class="reference external" href="#How-effects-work">How effects work</a></p></li>
<li><p><a class="reference external" href="#How-to-constrain-parameters">How to constrain parameters</a></p></li>
<li><p><a class="reference external" href="#How-to-make-a-PyroModule-Bayesian">How to make a PyroModule Bayesian</a></p></li>
<li><p><a class="reference external" href="#⚠-Caution:-accessing-attributes-inside-plates">Caution: accessing attributes inside plates</a></p></li>
<li><p><a class="reference external" href="#How-to-create-a-complex-nested-PyroModule">How to create a complex nested PyroModule</a></p></li>
<li><p><a class="reference external" href="#How-naming-works">How naming works</a></p></li>
<li><p><a class="reference external" href="#⚠-Caution:-avoiding-duplicate-names">Caution: avoiding duplicate names</a></p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">pyro</span>
<span class="kn">import</span> <span class="nn">pyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">import</span> <span class="nn">pyro.poutine</span> <span class="k">as</span> <span class="nn">poutine</span>
<span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">constraints</span>
<span class="kn">from</span> <span class="nn">pyro.nn</span> <span class="kn">import</span> <span class="n">PyroModule</span><span class="p">,</span> <span class="n">PyroParam</span><span class="p">,</span> <span class="n">PyroSample</span>
<span class="kn">from</span> <span class="nn">pyro.nn.module</span> <span class="kn">import</span> <span class="n">to_pyro_module_</span>
<span class="kn">from</span> <span class="nn">pyro.infer</span> <span class="kn">import</span> <span class="n">SVI</span><span class="p">,</span> <span class="n">Trace_ELBO</span>
<span class="kn">from</span> <span class="nn">pyro.infer.autoguide</span> <span class="kn">import</span> <span class="n">AutoNormal</span>
<span class="kn">from</span> <span class="nn">pyro.optim</span> <span class="kn">import</span> <span class="n">Adam</span>

<span class="n">smoke_test</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;CI&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">pyro</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;1.8.1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="How-PyroModule-works">
<h3>How <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> works<a class="headerlink" href="#How-PyroModule-works" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule">PyroModule</a> aims to combine Pyro’s primitives and effect handlers with PyTorch’s <a class="reference external" href="https://pytorch.org/docs/stable/nn.html#torch.nn.Module">nn.Module</a> idiom, thereby enabling Bayesian treatment of existing <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>s and enabling model serving via <a class="reference external" href="https://pytorch.org/docs/stable/jit.html#torch.jit.trace_module">jit.trace_module</a>. Before you start using <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s it will help to understand how they work, so
you can avoid pitfalls.</p>
<p><code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> is a subclass of <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>. <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> enables Pyro effects by inserting effect handling logic on module attribute access, overriding the <code class="docutils literal notranslate"><span class="pre">.__getattr__()</span></code>, <code class="docutils literal notranslate"><span class="pre">.__setattr__()</span></code>, and <code class="docutils literal notranslate"><span class="pre">.__delattr__()</span></code> methods. Additionally, because some effects (like sampling) apply only once per model invocation, <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> overrides the <code class="docutils literal notranslate"><span class="pre">.__call__()</span></code> method to ensure samples are generated at most once per <code class="docutils literal notranslate"><span class="pre">.__call__()</span></code> invocation (note <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> subclasses typically implement
a <code class="docutils literal notranslate"><span class="pre">.forward()</span></code> method that is called by <code class="docutils literal notranslate"><span class="pre">.__call__()</span></code>).</p>
</section>
<section id="How-to-create-a-PyroModule">
<h3>How to create a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code><a class="headerlink" href="#How-to-create-a-PyroModule" title="Permalink to this headline">¶</a></h3>
<p>There are three ways to create a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>. Let’s start with a <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> that is not a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Linear</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">out_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">+</span> <span class="n">input_</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>

<span class="n">linear</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">PyroModule</span><span class="p">)</span>

<span class="n">example_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">example_output</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">example_output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The first way to create a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> is to create a subclass of <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>. You can update any <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> you’ve written to be a PyroModule, e.g.</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">- class Linear(nn.Module):</span><span class="w"></span>
<span class="gi">+ class Linear(PyroModule):</span><span class="w"></span>
<span class="w"> </span>     def __init__(self, in_size, out_size):<span class="w"></span>
<span class="w"> </span>         super().__init__()<span class="w"></span>
<span class="w"> </span>         self.weight = ...<span class="w"></span>
<span class="w"> </span>         self.bias = ...<span class="w"></span>
<span class="w"> </span>     ...<span class="w"></span>
</pre></div>
</div>
<p>Alternatively if you want to use third-party code like the <code class="docutils literal notranslate"><span class="pre">Linear</span></code> above you can subclass it, using <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> as a mixin class</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PyroLinear</span><span class="p">(</span><span class="n">Linear</span><span class="p">,</span> <span class="n">PyroModule</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">linear</span> <span class="o">=</span> <span class="n">PyroLinear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">Linear</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">PyroModule</span><span class="p">)</span>

<span class="n">example_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">example_output</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">example_output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The second way to create a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> is to use bracket syntax <code class="docutils literal notranslate"><span class="pre">PyroModule[-]</span></code> to automatically denote a trivial mixin class as above.</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">- linear = Linear(5, 2)</span><span class="w"></span>
<span class="gi">+ linear = PyroModule[Linear](5, 2)</span><span class="w"></span>
</pre></div>
</div>
<p>In our case we can write</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linear</span> <span class="o">=</span> <span class="n">PyroModule</span><span class="p">[</span><span class="n">Linear</span><span class="p">](</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">Linear</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">PyroModule</span><span class="p">)</span>

<span class="n">example_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">example_output</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">example_output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The one difference between manual subclassing and using <code class="docutils literal notranslate"><span class="pre">PyroModule[-]</span></code> is that <code class="docutils literal notranslate"><span class="pre">PyroModule[-]</span></code> also ensures all <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> superclasses also become <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s, which is important for class hierarchies in library code. For example since <code class="docutils literal notranslate"><span class="pre">nn.GRU</span></code> is a subclass of <code class="docutils literal notranslate"><span class="pre">nn.RNN</span></code>, also <code class="docutils literal notranslate"><span class="pre">PyroModule[nn.GRU]</span></code> will be a subclass of <code class="docutils literal notranslate"><span class="pre">PyroModule[nn.RNN]</span></code>.</p>
<p>The third way to create a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> is to change the type of an existing <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> instance in-place using <a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.to_pyro_module_">to_pyro_module_()</a>. This is useful if you’re using a third-party module factory helper or updating an existing script, e.g.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linear</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">PyroModule</span><span class="p">)</span>

<span class="n">to_pyro_module_</span><span class="p">(</span><span class="n">linear</span><span class="p">)</span>  <span class="c1"># this operates in-place</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">Linear</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">PyroModule</span><span class="p">)</span>

<span class="n">example_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">example_output</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">example_output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="How-effects-work">
<h3>How effects work<a class="headerlink" href="#How-effects-work" title="Permalink to this headline">¶</a></h3>
<p>So far we’ve created <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s but haven’t made use of Pyro effects. But already the <code class="docutils literal notranslate"><span class="pre">nn.Parameter</span></code> attributes of our <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s act like <a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.param">pyro.param</a> statements: they synchronize with Pyro’s param store, and they can be recorded in traces.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>

<span class="c1"># This is not traced:</span>
<span class="n">linear</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">with</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="k">as</span> <span class="n">tr</span><span class="p">:</span>
    <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">linear</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<span class="c1"># Now this is traced:</span>
<span class="n">to_pyro_module_</span><span class="p">(</span><span class="n">linear</span><span class="p">)</span>
<span class="k">with</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="k">as</span> <span class="n">tr</span><span class="p">:</span>
    <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">linear</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Linear
[]
[]
PyroLinear
[&#39;bias&#39;, &#39;weight&#39;]
[&#39;bias&#39;, &#39;weight&#39;]
</pre></div></div>
</div>
</section>
<section id="How-to-constrain-parameters">
<h3>How to constrain parameters<a class="headerlink" href="#How-to-constrain-parameters" title="Permalink to this headline">¶</a></h3>
<p>Pyro parameters allow constraints, and often we want our <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> parameters to obey constraints. You can constrain a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>’s parameters by replacing <code class="docutils literal notranslate"><span class="pre">nn.Parameter</span></code> with a <a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroParam">PyroParam</a> attribute. For example to ensure the <code class="docutils literal notranslate"><span class="pre">.bias</span></code> attribute is positive, we can set it to</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;params before:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">linear</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()])</span>

<span class="n">linear</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">PyroParam</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">(),</span> <span class="n">constraint</span><span class="o">=</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;params after:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">linear</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bias:&quot;</span><span class="p">,</span> <span class="n">linear</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

<span class="n">example_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">example_output</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">example_output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
params before: [&#39;weight&#39;, &#39;bias&#39;]
params after: [&#39;weight&#39;, &#39;bias_unconstrained&#39;]
bias: tensor([0.9777, 0.8773], grad_fn=&lt;AddBackward0&gt;)
</pre></div></div>
</div>
<p>Now PyTorch will optimize the <code class="docutils literal notranslate"><span class="pre">.bias_unconstrained</span></code> parameter, and each time we access the <code class="docutils literal notranslate"><span class="pre">.bias</span></code> attribute it will read and transform the <code class="docutils literal notranslate"><span class="pre">.bias_unconstrained</span></code> parameter (similar to a Python <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>).</p>
<p>If you know the constraint beforehand, you can build it into the module constructor, e.g.</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span> class Linear(PyroModule):<span class="w"></span>
<span class="w"> </span>     def __init__(self, in_size, out_size):<span class="w"></span>
<span class="w"> </span>         super().__init__()<span class="w"></span>
<span class="w"> </span>         self.weight = ...<span class="w"></span>
<span class="gd">-         self.bias = nn.Parameter(torch.randn(out_size))</span><span class="w"></span>
<span class="gi">+         self.bias = PyroParam(torch.randn(out_size).exp(),</span><span class="w"></span>
<span class="gi">+                               constraint=constraints.positive)</span><span class="w"></span>
<span class="w"> </span>     ...<span class="w"></span>
</pre></div>
</div>
</section>
<section id="How-to-make-a-PyroModule-Bayesian">
<h3>How to make a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> Bayesian<a class="headerlink" href="#How-to-make-a-PyroModule-Bayesian" title="Permalink to this headline">¶</a></h3>
<p>So far our <code class="docutils literal notranslate"><span class="pre">Linear</span></code> module is still deterministic. To make it randomized and Bayesian, we’ll replace <code class="docutils literal notranslate"><span class="pre">nn.Parameter</span></code> and <code class="docutils literal notranslate"><span class="pre">PyroParam</span></code> attributes with <a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroSample">PyroSample</a> attributes, specifying a prior. Let’s put a simple prior over the weights, taking care to expand its shape to <code class="docutils literal notranslate"><span class="pre">[5,2]</span></code> and declare event dimensions with
<a class="reference external" href="http://docs.pyro.ai/en/stable/distributions.html#pyro.distributions.torch_distribution.TorchDistributionMixin.to_event">.to_event()</a> (as explained in the <a class="reference external" href="https://pyro.ai/examples/tensor_shapes.html">tensor shapes tutorial</a>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;params before:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">linear</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()])</span>

<span class="n">linear</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;params after:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">linear</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weight:&quot;</span><span class="p">,</span> <span class="n">linear</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weight:&quot;</span><span class="p">,</span> <span class="n">linear</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

<span class="n">example_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">example_output</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">example_output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
params before: [&#39;weight&#39;, &#39;bias_unconstrained&#39;]
params after: [&#39;bias_unconstrained&#39;]
weight: tensor([[-0.8668, -0.0150],
        [ 3.4642,  1.9076],
        [ 0.4717,  1.0565],
        [-1.2032,  1.0821],
        [-0.1712,  0.4711]])
weight: tensor([[-1.2577, -0.5242],
        [-0.7785, -1.0806],
        [ 0.6239, -0.4884],
        [-0.2580, -1.2288],
        [-0.7540, -1.9375]])
</pre></div></div>
</div>
<p>Notice that the <code class="docutils literal notranslate"><span class="pre">.weight</span></code> parameter now disappears, and each time we call <code class="docutils literal notranslate"><span class="pre">linear()</span></code> a new weight is sampled from the prior. In fact, the weight is sampled when the <code class="docutils literal notranslate"><span class="pre">Linear.forward()</span></code> accesses the <code class="docutils literal notranslate"><span class="pre">.weight</span></code> attribute: this attribute now has the special behavior of sampling from the prior.</p>
<p>We can see all the Pyro effects that appear in the trace:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="k">as</span> <span class="n">tr</span><span class="p">:</span>
    <span class="n">linear</span><span class="p">(</span><span class="n">example_input</span><span class="p">)</span>
<span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
param bias tensor([0.9777, 0.8773], grad_fn=&lt;AddBackward0&gt;)
sample weight tensor([[ 1.8043,  1.5494],
        [ 0.0128,  1.4100],
        [-0.2155,  0.6375],
        [ 1.1202,  1.9672],
        [-0.1576, -0.6957]])
</pre></div></div>
</div>
<p>So far we’ve modified a third-party module to be Bayesian</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">linear</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">to_pyro_module_</span><span class="p">(</span><span class="n">linear</span><span class="p">)</span>
<span class="n">linear</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">PyroParam</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">linear</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>If you are creating a model from scratch, you could instead define a new class</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BayesianLinear</span><span class="p">(</span><span class="n">PyroModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">):</span>
       <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span>
           <span class="n">prior</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">out_size</span><span class="p">])</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span>
           <span class="n">prior</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">])</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>  <span class="c1"># this line samples bias and weight</span>
</pre></div>
</div>
</div>
<p>Note that samples are drawn at most once per <code class="docutils literal notranslate"><span class="pre">.__call__()</span></code> invocation, for example</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BayesianLinear</span><span class="p">(</span><span class="n">PyroModule</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">weight1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>      <span class="c1"># Draws a sample.</span>
        <span class="n">weight2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>      <span class="c1"># Reads previous sample.</span>
        <span class="k">assert</span> <span class="n">weight2</span> <span class="ow">is</span> <span class="n">weight1</span>  <span class="c1"># All accesses should agree.</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="⚠-Caution:-accessing-attributes-inside-plates">
<h3>⚠ Caution: accessing attributes inside plates<a class="headerlink" href="#⚠-Caution:-accessing-attributes-inside-plates" title="Permalink to this headline">¶</a></h3>
<p>Because <code class="docutils literal notranslate"><span class="pre">PyroSample</span></code> and <code class="docutils literal notranslate"><span class="pre">PyroParam</span></code> attributes are modified by Pyro effects, we need to take care where parameters are accessed. For example <a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.plate">pyro.plate</a> contexts can change the shape of sample and param sites. Consider a model with one latent variable and a batched observation statement. We see that the only difference between these two models is where the <code class="docutils literal notranslate"><span class="pre">.loc</span></code> attribute is accessed.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NormalModel</span><span class="p">(</span><span class="n">PyroModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">GlobalModel</span><span class="p">(</span><span class="n">NormalModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># If .loc is accessed (for the first time) outside the plate,</span>
        <span class="c1"># then it will have empty shape ().</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>
        <span class="k">assert</span> <span class="n">loc</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
        <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LocalModel</span><span class="p">(</span><span class="n">NormalModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="c1"># If .loc is accessed (for the first time) inside the plate,</span>
            <span class="c1"># then it will be expanded by the plate to shape (plate.size,).</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>
            <span class="k">assert</span> <span class="n">loc</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),)</span>
            <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">LocalModel</span><span class="p">()(</span><span class="n">data</span><span class="p">)</span>
<span class="n">GlobalModel</span><span class="p">()(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="How-to-create-a-complex-nested-PyroModule">
<h3>How to create a complex nested <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code><a class="headerlink" href="#How-to-create-a-complex-nested-PyroModule" title="Permalink to this headline">¶</a></h3>
<p>To perform inference with the above <code class="docutils literal notranslate"><span class="pre">BayesianLinear</span></code> module we’ll need to wrap it in probabilistic model with a likelihood; that wrapper will also be a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">PyroModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">BayesianLinear</span><span class="p">(</span><span class="n">in_size</span><span class="p">,</span> <span class="n">out_size</span><span class="p">)</span>  <span class="c1"># this is a PyroModule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_scale</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">obs_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># this samples linear.bias and linear.weight</span>
        <span class="n">obs_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_scale</span>    <span class="c1"># this samples self.obs_scale</span>
        <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;instances&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">obs_loc</span><span class="p">,</span> <span class="n">obs_scale</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">obs</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Whereas a usual <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> can be trained with a simple PyTorch optimizer, a Pyro model requires probabilistic inference, e.g. using <a class="reference external" href="http://docs.pyro.ai/en/stable/inference_algos.html#pyro.infer.svi.SVI">SVI</a> and an <a class="reference external" href="http://docs.pyro.ai/en/stable/infer.autoguide.html#pyro.infer.autoguide.AutoNormal">AutoNormal</a> guide. See the <a class="reference external" href="http://pyro.ai/examples/bayesian_regression.html">bayesian regression tutorial</a> for details.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">guide</span> <span class="o">=</span> <span class="n">AutoNormal</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">Adam</span><span class="p">({</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}),</span> <span class="n">Trace_ELBO</span><span class="p">())</span>
<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="n">smoke_test</span> <span class="k">else</span> <span class="mi">501</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;step </span><span class="si">{}</span><span class="s2"> loss = </span><span class="si">{:0.4g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
step 0 loss = 7.186
step 100 loss = 2.185
step 200 loss = 1.87
step 300 loss = 1.739
step 400 loss = 1.691
step 500 loss = 1.673
CPU times: user 2.35 s, sys: 24.8 ms, total: 2.38 s
Wall time: 2.39 s
</pre></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">PyroSample</span></code> statements may also depend on other sample statements or parameters. In this case the <code class="docutils literal notranslate"><span class="pre">prior</span></code> can be a callable depending on <code class="docutils literal notranslate"><span class="pre">self</span></code>, rather than a constant distribution. For example consider the hierarchical model</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">PyroModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dof</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

<span class="n">Model</span><span class="p">()()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor(0.5387)
</pre></div></div>
</div>
</section>
<section id="How-naming-works">
<h3>How naming works<a class="headerlink" href="#How-naming-works" title="Permalink to this headline">¶</a></h3>
<p>In the above code we saw a <code class="docutils literal notranslate"><span class="pre">BayesianLinear</span></code> model embedded inside another <code class="docutils literal notranslate"><span class="pre">Model</span></code>. Both were <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s. Whereas simple <a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.sample">pyro.sample</a> statements require name strings, <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code> attributes handle naming automatically. Let’s see how that works with the above <code class="docutils literal notranslate"><span class="pre">model</span></code> and <code class="docutils literal notranslate"><span class="pre">guide</span></code> (since <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> is also a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>).</p>
<p>Let’s trace executions of the model and the guide.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="k">as</span> <span class="n">tr</span><span class="p">:</span>
    <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sample linear.bias torch.Size([2])
sample linear.weight torch.Size([5, 2])
sample obs_scale torch.Size([])
sample instances torch.Size([100])
sample obs torch.Size([100, 2])
</pre></div></div>
</div>
<p>Observe that <code class="docutils literal notranslate"><span class="pre">model.linear.bias</span></code> corresponds to the <code class="docutils literal notranslate"><span class="pre">linear.bias</span></code> name, and similarly for the <code class="docutils literal notranslate"><span class="pre">model.linear.weight</span></code> and <code class="docutils literal notranslate"><span class="pre">model.obs_scale</span></code> attributes. The “instances” site corresponds to the plate, and the “obs” site corresponds to the likelihood. Next examine the guide:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="k">as</span> <span class="n">tr</span><span class="p">:</span>
    <span class="n">guide</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
param AutoNormal.locs.linear.bias torch.Size([2])
param AutoNormal.scales.linear.bias torch.Size([2])
sample linear.bias_unconstrained torch.Size([2])
sample linear.bias torch.Size([2])
param AutoNormal.locs.linear.weight torch.Size([5, 2])
param AutoNormal.scales.linear.weight torch.Size([5, 2])
sample linear.weight_unconstrained torch.Size([5, 2])
sample linear.weight torch.Size([5, 2])
param AutoNormal.locs.obs_scale torch.Size([])
param AutoNormal.scales.obs_scale torch.Size([])
sample obs_scale_unconstrained torch.Size([])
sample obs_scale torch.Size([])
</pre></div></div>
</div>
<p>We see the guide learns posteriors over three random variables: <code class="docutils literal notranslate"><span class="pre">linear.bias</span></code>, <code class="docutils literal notranslate"><span class="pre">linear.weight</span></code>, and <code class="docutils literal notranslate"><span class="pre">obs_scale</span></code>. For each of these, the guide learns a <code class="docutils literal notranslate"><span class="pre">(loc,scale)</span></code> pair of parameters, which are stored internally in nested <code class="docutils literal notranslate"><span class="pre">PyroModules</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AutoNormal</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="n">PyroModule</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scales</span> <span class="o">=</span> <span class="n">PyroModule</span><span class="p">()</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> contains a <code class="docutils literal notranslate"><span class="pre">pyro.sample</span></code> statement for each unconstrained latent site followed by a <a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.deterministic">pyro.deterministic</a> statement to map the unconstrained sample to a constrained posterior sample.</p>
</section>
<section id="⚠-Caution:-avoiding-duplicate-names">
<h3>⚠ Caution: avoiding duplicate names<a class="headerlink" href="#⚠-Caution:-avoiding-duplicate-names" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s name their attributes automatically, event for attributes nested deeply in other <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s. However care must be taken when mixing usual <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>s with <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s, because <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>s do not support automatic site naming.</p>
<p>Within a single model (or guide):</p>
<p>If there is only a single <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>, then your are safe.</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span> class Model(nn.Module):        # not a PyroModule<span class="w"></span>
<span class="w"> </span>     def __init__(self):<span class="w"></span>
<span class="w"> </span>         self.x = PyroModule()<span class="w"></span>
<span class="gd">-         self.y = PyroModule()  # Could lead to name conflict.</span><span class="w"></span>
<span class="gi">+         self.y = nn.Module()  # Has no Pyro names, so avoids conflict.</span><span class="w"></span>
</pre></div>
</div>
<p>If there are only two <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s then one must be an attribute of the other.</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w">class Model(PyroModule):</span>
<span class="w"> </span>   def __init__(self):<span class="w"></span>
<span class="w"> </span>      self.x = PyroModule()  # ok<span class="w"></span>
</pre></div>
</div>
<p>If you have two <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s that are not attributes of each other, then they must be connected by attribute links through other <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>s. These can be sibling links</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">- class Model(nn.Module):     # Could lead to name conflict.</span><span class="w"></span>
<span class="gi">+ class Model(PyroModule):    # Ensures names are unique.</span><span class="w"></span>
<span class="w"> </span>     def __init__(self):<span class="w"></span>
<span class="w"> </span>         self.x = PyroModule()<span class="w"></span>
<span class="w"> </span>         self.y = PyroModule()<span class="w"></span>
</pre></div>
</div>
<p>or ancestor links</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span> class Model(PyroModule):<span class="w"></span>
<span class="w"> </span>     def __init__(self):<span class="w"></span>
<span class="gd">-         self.x = nn.Module()    # Could lead to name conflict.</span><span class="w"></span>
<span class="gi">+         self.x = PyroModule()   # Ensures y is conected to root Model.</span><span class="w"></span>
<span class="w"> </span>         self.x.y = PyroModule()<span class="w"></span>
</pre></div>
</div>
<p>Sometimes you may want to store a <code class="docutils literal notranslate"><span class="pre">(model,guide)</span></code> pair in a single <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>, e.g. to serve them from C++. In this case it is safe to make them attributes of a container <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>, but that container should <em>not</em> be a <code class="docutils literal notranslate"><span class="pre">PyroModule</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Container</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>            <span class="c1"># This cannot be a PyroModule.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="p">):</span>  <span class="c1"># These may be PyroModules.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guide</span> <span class="o">=</span> <span class="n">guide</span>
    <span class="c1"># This is a typical trace-replay pattern seen in model serving.</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guide</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">poutine</span><span class="o">.</span><span class="n">replay</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tr</span><span class="p">)(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tensor_shapes.html" class="btn btn-neutral float-left" title="Tensor shapes in Pyro" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="workflow.html" class="btn btn-neutral float-right" title="High-dimensional Bayesian workflow, with applications to SARS-CoV-2 strains" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Pyro Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>