<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Pyro Tutorials 1.8.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="&lt;no title&gt;" href="workflow.html" />
    <link rel="prev" title="&lt;no title&gt;" href="tensor_shapes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.8.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Practical Pyro and PyTorch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="svi_horovod.html">Example: distributed training via Horovod</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep Generative Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cevae.html">Example: Causal Effect VAE</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_gamma.html">Example: Sparse Gamma Deep Exponential Family</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Discrete Latent Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="toy_mixture_model_discrete_enumeration.html">Example: Toy Mixture Model With Discrete Enumeration</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm.html">Example: Hidden Markov Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="capture_recapture.html">Example: Capture-Recapture Models (CJS Models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_hmm.html">Example: hierarchical mixed-effect hidden Markov models</a></li>
<li class="toctree-l1"><a class="reference internal" href="einsum.html">Example: Discrete Factor Graph Inference with Plated Einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="lda.html">Example: Amortized Latent Dirichlet Allocation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Customizing Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="neutra.html">Example: Neural MCMC with NeuTraReparam</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_regression.html">Example: Sparse Bayesian Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoname_examples.html">Example: reducing boilerplate with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.autoname</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Time Series</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="forecast_simple.html">Multivariate Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries.html">Example: Gaussian Process Time Series Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Gaussian Processes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dkl.html">Example: Deep Kernel Learning</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Epidemiology</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="epi_sir.html">Example: Univariate epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="epi_regional.html">Example: Regional epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="sir_hmc.html">Example: Epidemiological inference via HMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Biological sequences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mue_profile.html">Example: Constant + MuE (Profile HMM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mue_factor.html">Example: Probabilistic PCA + MuE (FactorMuE)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Inference Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="baseball.html">Example: analyzing baseball stats with MCMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcmc.html">Example: Inference with Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="lkj.html">Example: MCMC with an LKJ prior over covariances</a></li>
<li class="toctree-l1"><a class="reference internal" href="smcfilter.html">Example: Sequential Monte Carlo Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclined_plane.html">Example: importance sampling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Understanding Pyro's Internals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="minipyro.html">Mini-Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm_funsor.html">Example: hidden Markov models with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.funsor</span></code> and <code class="docutils literal notranslate"><span class="pre">pyroapi</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pyro Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/modules.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<dl>
<dt>{</dt><dd><dl>
<dt>“cells”: [</dt><dd><dl>
<dt>{</dt><dd><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Modules in Pyron”,
“n”,
“n”,
“This tutorial introduces [PyroModule](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule</a>), Pyro’s Bayesian extension of PyTorch’s [nn.Module](<a class="reference external" href="https://pytorch.org/docs/stable/nn.html#torch.nn.Module">https://pytorch.org/docs/stable/nn.html#torch.nn.Module</a>) class. Before starting you should understand the basics of Pyro [models and inference](<a class="reference external" href="http://pyro.ai/examples/intro_long.html">http://pyro.ai/examples/intro_long.html</a>), understand the two primitives [pyro.sample()](<a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.sample">http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.sample</a>) and [pyro.param()](<a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.param">http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.param</a>), and understand the basics of Pyro’s [effect handlers](<a class="reference external" href="http://pyro.ai/examples/effect_handlers.html">http://pyro.ai/examples/effect_handlers.html</a>) (e.g. by browsing [minipyro.py](<a class="reference external" href="https://github.com/pyro-ppl/pyro/blob/dev/pyro/contrib/minipyro.py)).n">https://github.com/pyro-ppl/pyro/blob/dev/pyro/contrib/minipyro.py)).n</a>”,
“n”,
“#### Summary:n”,
“n”,
“- [PyroModule](http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule)s are like [nn.Module](https://pytorch.org/docs/stable/nn.html#torch.nn.Module)s but allow Pyro effects for sampling and constraints.n”,
“- <cite>PyroModule</cite> is a mixin subclass of <cite>nn.Module</cite> that overrides attribute access (e.g. <cite>.__getattr__()</cite>).n”,
“- There are three different ways to create a <cite>PyroModule</cite>:n”,
”  - create a new subclass: <cite>class MyModule(PyroModule): …</cite>,n”,
”  - Pyro-ize an existing class: <cite>MyModule = PyroModule[OtherModule]</cite>, orn”,
”  - Pyro-ize an existing <cite>nn.Module</cite> instance in-place: <cite>to_pyro_module_(my_module)</cite>.n”,
“- Usual <cite>nn.Parameter</cite> attributes of a <cite>PyroModule</cite> become Pyro parameters.n”,
“- Parameters of a <cite>PyroModule</cite> synchronize with Pyro’s global param store.n”,
“- You can add constrained parameters by creating [PyroParam](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroParam">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroParam</a>) objects.n”,
“- You can add stochastic attributes by creating [PyroSample](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroSample">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroSample</a>) objects.n”,
“- Parameters and stochastic attributes are named automatically (no string required).n”,
“- <cite>PyroSample</cite> attributes are sampled once per <cite>.__call__()</cite> of the outermost <cite>PyroModule</cite>.n”,
“- To enable Pyro effects on methods other than <cite>.__call__()</cite>, decorate them with &#64;[pyro_method](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.pyro_method).n">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.pyro_method).n</a>”,
“- A <cite>PyroModule</cite> model may contain <cite>nn.Module</cite> attributes.n”,
“- An <cite>nn.Module</cite> model may contain at most one <cite>PyroModule</cite> attribute (see [naming section](#Caution-avoiding-duplicate-names)).n”,
“- An <cite>nn.Module</cite> may contain both a <cite>PyroModule</cite> model and <cite>PyroModule</cite> guide (e.g. [Predictive](<a class="reference external" href="http://docs.pyro.ai/en/stable/inference_algos.html#pyro.infer.predictive.Predictive)).n">http://docs.pyro.ai/en/stable/inference_algos.html#pyro.infer.predictive.Predictive)).n</a>”,
“n”,
“#### Table of Contentsn”,
“n”,
“- [How PyroModule works](#How-PyroModule-works)n”,
“- [How to create a PyroModule](#How-to-create-a-PyroModule)n”,
“- [How effects work](#How-effects-work)n”,
“- [How to constrain parameters](#How-to-constrain-parameters)n”,
“- [How to make a PyroModule Bayesian](#How-to-make-a-PyroModule-Bayesian)n”,
“- [Caution: accessing attributes inside plates](#⚠-Caution:-accessing-attributes-inside-plates)n”,
“- [How to create a complex nested PyroModule](#How-to-create-a-complex-nested-PyroModule)n”,
“- [How naming works](#How-naming-works)n”,
“- [Caution: avoiding duplicate names](#⚠-Caution:-avoiding-duplicate-names)”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 1,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“import osn”,
“import torchn”,
“import torch.nn as nnn”,
“import pyron”,
“import pyro.distributions as distn”,
“import pyro.poutine as poutinen”,
“from torch.distributions import constraintsn”,
“from pyro.nn import PyroModule, PyroParam, PyroSamplen”,
“from pyro.nn.module import <a href="#id3"><span class="problematic" id="id4">to_pyro_module_</span></a>n”,
“from pyro.infer import SVI, Trace_ELBOn”,
“from pyro.infer.autoguide import AutoNormaln”,
“from pyro.optim import Adamn”,
“n”,
“smoke_test = (‘CI’ in os.environ)n”,
“assert pyro.__version__.startswith(‘1.8.1’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## How <cite>PyroModule</cite> works  &lt;a class=&quot;anchor&quot; id=&quot;How-PyroModule-works&quot;&gt;&lt;/a&gt;n”,
“n”,
“[PyroModule](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroModule</a>) aims to combine Pyro’s primitives and effect handlers with PyTorch’s [nn.Module](<a class="reference external" href="https://pytorch.org/docs/stable/nn.html#torch.nn.Module">https://pytorch.org/docs/stable/nn.html#torch.nn.Module</a>) idiom, thereby enabling Bayesian treatment of existing <cite>nn.Module`s and enabling model serving via [jit.trace_module](https://pytorch.org/docs/stable/jit.html#torch.jit.trace_module). Before you start using `PyroModule`s it will help to understand how they work, so you can avoid pitfalls.n”,
“n”,
“`PyroModule</cite> is a subclass of <cite>nn.Module</cite>. <cite>PyroModule</cite> enables Pyro effects by inserting effect handling logic on module attribute access, overriding the <cite>.__getattr__()</cite>, <cite>.__setattr__()</cite>, and <cite>.__delattr__()</cite> methods. Additionally, because some effects (like sampling) apply only once per model invocation, <cite>PyroModule</cite> overrides the <cite>.__call__()</cite> method to ensure samples are generated at most once per <cite>.__call__()</cite> invocation (note <cite>nn.Module</cite> subclasses typically implement a <cite>.forward()</cite> method that is called by <cite>.__call__()</cite>).”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## How to create a <cite>PyroModule</cite>   &lt;a class=&quot;anchor&quot; id=&quot;How-to-create-a-PyroModule&quot;&gt;&lt;/a&gt;n”,
“n”,
“There are three ways to create a <cite>PyroModule</cite>. Let’s start with a <cite>nn.Module</cite> that is not a <cite>PyroModule</cite>:”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 2,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“class Linear(nn.Module):n”,
”    def __init__(self, in_size, out_size):n”,
”        super().__init__()n”,
”        self.weight = nn.Parameter(torch.randn(in_size, out_size))n”,
”        self.bias = nn.Parameter(torch.randn(out_size))n”,
”        n”,
”    def forward(self, <a href="#id5"><span class="problematic" id="id6">input_</span></a>):n”,
”        return self.bias + <a href="#id7"><span class="problematic" id="id8">input_</span></a> &#64; self.weightn”,
”    n”,
“linear = Linear(5, 2)n”,
“assert isinstance(linear, nn.Module)n”,
“assert not isinstance(linear, PyroModule)n”,
“n”,
“example_input = torch.randn(100, 5)n”,
“example_output = linear(example_input)n”,
“assert example_output.shape == (100, 2)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“The first way to create a <cite>PyroModule</cite> is to create a subclass of <cite>PyroModule</cite>. You can update any <cite>nn.Module</cite> you’ve written to be a PyroModule, e.g.n”,
“<code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;-</span> <span class="pre">class</span> <span class="pre">Linear(nn.Module):\n&quot;,</span>
<span class="pre">&quot;+</span> <span class="pre">class</span> <span class="pre">Linear(PyroModule):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">__init__(self,</span> <span class="pre">in_size,</span> <span class="pre">out_size):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">super().__init__()\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.weight</span> <span class="pre">=</span> <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.bias</span> <span class="pre">=</span> <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“Alternatively if you want to use third-party code like the <cite>Linear</cite> above you can subclass it, using <cite>PyroModule</cite> as a mixin class”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 3,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“class PyroLinear(Linear, PyroModule):n”,
”    passn”,
“n”,
“linear = PyroLinear(5, 2)n”,
“assert isinstance(linear, nn.Module)n”,
“assert isinstance(linear, Linear)n”,
“assert isinstance(linear, PyroModule)n”,
“n”,
“example_input = torch.randn(100, 5)n”,
“example_output = linear(example_input)n”,
“assert example_output.shape == (100, 2)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“The second way to create a <cite>PyroModule</cite> is to use bracket syntax <cite>PyroModule[-]</cite> to automatically denote a trivial mixin class as above.n”,
“<code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;-</span> <span class="pre">linear</span> <span class="pre">=</span> <span class="pre">Linear(5,</span> <span class="pre">2)\n&quot;,</span>
<span class="pre">&quot;+</span> <span class="pre">linear</span> <span class="pre">=</span> <span class="pre">PyroModule[Linear](5,</span> <span class="pre">2)\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“In our case we can write”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 4,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“linear = PyroModule[Linear](5, 2)n”,
“assert isinstance(linear, nn.Module)n”,
“assert isinstance(linear, Linear)n”,
“assert isinstance(linear, PyroModule)n”,
“n”,
“example_input = torch.randn(100, 5)n”,
“example_output = linear(example_input)n”,
“assert example_output.shape == (100, 2)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“The one difference between manual subclassing and using <cite>PyroModule[-]</cite> is that <cite>PyroModule[-]</cite> also ensures all <cite>nn.Module</cite> superclasses also become <cite>PyroModule`s, which is important for class hierarchies in library code. For example since `nn.GRU</cite> is a subclass of <cite>nn.RNN</cite>, also <cite>PyroModule[nn.GRU]</cite> will be a subclass of <cite>PyroModule[nn.RNN]</cite>.n”,
“n”,
“The third way to create a <cite>PyroModule</cite> is to change the type of an existing <cite>nn.Module</cite> instance in-place using [to_pyro_module_()](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.to_pyro_module_">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.to_pyro_module_</a>). This is useful if you’re using a third-party module factory helper or updating an existing script, e.g.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 5,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“linear = Linear(5, 2)n”,
“assert isinstance(linear, nn.Module)n”,
“assert not isinstance(linear, PyroModule)n”,
“n”,
“to_pyro_module_(linear)  # this operates in-placen”,
“assert isinstance(linear, nn.Module)n”,
“assert isinstance(linear, Linear)n”,
“assert isinstance(linear, PyroModule)n”,
“n”,
“example_input = torch.randn(100, 5)n”,
“example_output = linear(example_input)n”,
“assert example_output.shape == (100, 2)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## How effects work &lt;a class=&quot;anchor&quot; id=&quot;How-effects-work&quot;&gt;&lt;/a&gt;n”,
“n”,
“So far we’ve created <cite>PyroModule`s but haven’t made use of Pyro effects. But already the `nn.Parameter</cite> attributes of our <a href="#id1"><span class="problematic" id="id2">`</span></a>PyroModule`s act like [pyro.param](<a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.param">http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.param</a>) statements: they synchronize with Pyro’s param store, and they can be recorded in traces.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 6,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“Linearn”,
“[]n”,
“[]n”,
“PyroLinearn”,
“[‘bias’, ‘weight’]n”,
“[‘bias’, ‘weight’]n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“pyro.clear_param_store()n”,
“n”,
“# This is not traced:n”,
“linear = Linear(5, 2)n”,
“with poutine.trace() as tr:n”,
”    linear(example_input)n”,
“print(type(linear).__name__)n”,
“print(list(tr.trace.nodes.keys()))n”,
“print(list(pyro.get_param_store().keys()))n”,
“n”,
“# Now this is traced:n”,
“to_pyro_module_(linear)n”,
“with poutine.trace() as tr:n”,
”    linear(example_input)n”,
“print(type(linear).__name__)n”,
“print(list(tr.trace.nodes.keys()))n”,
“print(list(pyro.get_param_store().keys()))”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## How to constrain parameters  &lt;a class=&quot;anchor&quot; id=&quot;How-to-constrain-parameters&quot;&gt;&lt;/a&gt;n”,
“n”,
“Pyro parameters allow constraints, and often we want our <cite>nn.Module</cite> parameters to obey constraints. You can constrain a <cite>PyroModule</cite>’s parameters by replacing <cite>nn.Parameter</cite> with a [PyroParam](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroParam">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroParam</a>) attribute. For example to ensure the <cite>.bias</cite> attribute is positive, we can set it to”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 7,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“params before: [‘weight’, ‘bias’]n”,
“params after: [‘weight’, ‘bias_unconstrained’]n”,
“bias: tensor([0.9777, 0.8773], grad_fn=&lt;AddBackward0&gt;)n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“print(&quot;params before:&quot;, [name for name, _ in linear.named_parameters()])n”,
“n”,
“linear.bias = PyroParam(torch.randn(2).exp(), constraint=constraints.positive)n”,
“print(&quot;params after:&quot;, [name for name, _ in linear.named_parameters()])n”,
“print(&quot;bias:&quot;, linear.bias)n”,
“n”,
“example_input = torch.randn(100, 5)n”,
“example_output = linear(example_input)n”,
“assert example_output.shape == (100, 2)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Now PyTorch will optimize the <cite>.bias_unconstrained</cite> parameter, and each time we access the <cite>.bias</cite> attribute it will read and transform the <cite>.bias_unconstrained</cite> parameter (similar to a Python <cite>&#64;property</cite>).n”,
“n”,
“n”,
“If you know the constraint beforehand, you can build it into the module constructor, e.g.n”,
“<code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;</span>&#160; <span class="pre">class</span> <span class="pre">Linear(PyroModule):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">__init__(self,</span> <span class="pre">in_size,</span> <span class="pre">out_size):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">super().__init__()\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.weight</span> <span class="pre">=</span> <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;-</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.bias</span> <span class="pre">=</span> <span class="pre">nn.Parameter(torch.randn(out_size))\n&quot;,</span>
<span class="pre">&quot;+</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.bias</span> <span class="pre">=</span> <span class="pre">PyroParam(torch.randn(out_size).exp(),\n&quot;,</span>
<span class="pre">&quot;+</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">constraint=constraints.positive)\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;`</span></code>”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## How to make a <cite>PyroModule</cite>  Bayesian  &lt;a class=&quot;anchor&quot; id=&quot;How-to-make-a-PyroModule-Bayesian&quot;&gt;&lt;/a&gt;n”,
“n”,
“So far our <cite>Linear</cite> module is still deterministic. To make it randomized and Bayesian, we’ll replace <cite>nn.Parameter</cite> and <cite>PyroParam</cite> attributes with [PyroSample](<a class="reference external" href="http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroSample">http://docs.pyro.ai/en/stable/nn.html#pyro.nn.module.PyroSample</a>) attributes, specifying a prior. Let’s put a simple prior over the weights, taking care to expand its shape to <cite>[5,2]</cite> and declare event dimensions with [.to_event()](<a class="reference external" href="http://docs.pyro.ai/en/stable/distributions.html#pyro.distributions.torch_distribution.TorchDistributionMixin.to_event">http://docs.pyro.ai/en/stable/distributions.html#pyro.distributions.torch_distribution.TorchDistributionMixin.to_event</a>) (as explained in the [tensor shapes tutorial](<a class="reference external" href="https://pyro.ai/examples/tensor_shapes.html">https://pyro.ai/examples/tensor_shapes.html</a>)).”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 8,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“params before: [‘weight’, ‘bias_unconstrained’]n”,
“params after: [‘bias_unconstrained’]n”,
“weight: tensor([[-0.8668, -0.0150],n”,
”        [ 3.4642,  1.9076],n”,
”        [ 0.4717,  1.0565],n”,
”        [-1.2032,  1.0821],n”,
”        [-0.1712,  0.4711]])n”,
“weight: tensor([[-1.2577, -0.5242],n”,
”        [-0.7785, -1.0806],n”,
”        [ 0.6239, -0.4884],n”,
”        [-0.2580, -1.2288],n”,
”        [-0.7540, -1.9375]])n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“print(&quot;params before:&quot;, [name for name, _ in linear.named_parameters()])n”,
“n”,
“linear.weight = PyroSample(dist.Normal(0, 1).expand([5, 2]).to_event(2))n”,
“print(&quot;params after:&quot;, [name for name, _ in linear.named_parameters()])n”,
“print(&quot;weight:&quot;, linear.weight)n”,
“print(&quot;weight:&quot;, linear.weight)n”,
“n”,
“example_input = torch.randn(100, 5)n”,
“example_output = linear(example_input)n”,
“assert example_output.shape == (100, 2)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Notice that the <cite>.weight</cite> parameter now disappears, and each time we call <cite>linear()</cite> a new weight is sampled from the prior. In fact, the weight is sampled when the <cite>Linear.forward()</cite> accesses the <cite>.weight</cite> attribute: this attribute now has the special behavior of sampling from the prior.n”,
“n”,
“We can see all the Pyro effects that appear in the trace:”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 9,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“param bias tensor([0.9777, 0.8773], grad_fn=&lt;AddBackward0&gt;)n”,
“sample weight tensor([[ 1.8043,  1.5494],n”,
”        [ 0.0128,  1.4100],n”,
”        [-0.2155,  0.6375],n”,
”        [ 1.1202,  1.9672],n”,
”        [-0.1576, -0.6957]])n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“with poutine.trace() as tr:n”,
”    linear(example_input)n”,
“for site in tr.trace.nodes.values():n”,
”    print(site[&quot;type&quot;], site[&quot;name&quot;], site[&quot;value&quot;])”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“So far we’ve modified a third-party module to be Bayesiann”,
“<code class="docutils literal notranslate"><span class="pre">`py\n&quot;,</span>
<span class="pre">&quot;linear</span> <span class="pre">=</span> <span class="pre">Linear(...)\n&quot;,</span>
<span class="pre">&quot;to_pyro_module_(linear)\n&quot;,</span>
<span class="pre">&quot;linear.bias</span> <span class="pre">=</span> <span class="pre">PyroParam(...)\n&quot;,</span>
<span class="pre">&quot;linear.weight</span> <span class="pre">=</span> <span class="pre">PyroSample(...)\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“If you are creating a model from scratch, you could instead define a new class”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 10,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“class BayesianLinear(PyroModule):n”,
”    def __init__(self, in_size, out_size):n”,
”       super().__init__()n”,
”       self.bias = PyroSample(n”,
”           prior=dist.LogNormal(0, 1).expand([out_size]).to_event(1))n”,
”       self.weight = PyroSample(n”,
”           prior=dist.Normal(0, 1).expand([in_size, out_size]).to_event(2))n”,
“n”,
”    def forward(self, input):n”,
”        return self.bias + input &#64; self.weight  # this line samples bias and weight”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Note that samples are drawn at most once per <cite>.__call__()</cite> invocation, for examplen”,
“<code class="docutils literal notranslate"><span class="pre">`py\n&quot;,</span>
<span class="pre">&quot;class</span> <span class="pre">BayesianLinear(PyroModule):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160; <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">forward(self,</span> <span class="pre">input):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">weight1</span> <span class="pre">=</span> <span class="pre">self.weight</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">Draws</span> <span class="pre">a</span> <span class="pre">sample.\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">weight2</span> <span class="pre">=</span> <span class="pre">self.weight</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">Reads</span> <span class="pre">previous</span> <span class="pre">sample.\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">assert</span> <span class="pre">weight2</span> <span class="pre">is</span> <span class="pre">weight1</span>&#160; <span class="pre">#</span> <span class="pre">All</span> <span class="pre">accesses</span> <span class="pre">should</span> <span class="pre">agree.\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;`</span></code>”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## ⚠ Caution: accessing attributes inside plates  &lt;a class=&quot;anchor&quot; id=&quot;⚠-Caution:-accessing-attributes-inside-plates&quot;&gt;&lt;/a&gt;n”,
“n”,
“Because <cite>PyroSample</cite> and <cite>PyroParam</cite> attributes are modified by Pyro effects, we need to take care where parameters are accessed. For example [pyro.plate](<a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.plate">http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.plate</a>) contexts can change the shape of sample and param sites. Consider a model with one latent variable and a batched observation statement. We see that the only difference between these two models is where the <cite>.loc</cite> attribute is accessed.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 11,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“class NormalModel(PyroModule):n”,
”    def __init__(self):n”,
”        super().__init__()n”,
”        self.loc = PyroSample(dist.Normal(0, 1))n”,
“n”,
“class GlobalModel(NormalModel):n”,
”    def forward(self, data):n”,
”        # If .loc is accessed (for the first time) outside the plate,n”,
”        # then it will have empty shape ().n”,
”        loc = self.locn”,
”        assert loc.shape == ()n”,
”        with pyro.plate(&quot;data&quot;, len(data)):n”,
”            pyro.sample(&quot;obs&quot;, dist.Normal(loc, 1), obs=data)n”,
”        n”,
“class LocalModel(NormalModel):n”,
”    def forward(self, data):n”,
”        with pyro.plate(&quot;data&quot;, len(data)):n”,
”            # If .loc is accessed (for the first time) inside the plate,n”,
”            # then it will be expanded by the plate to shape (plate.size,).n”,
”            loc = self.locn”,
”            assert loc.shape == (len(data),)n”,
”            pyro.sample(&quot;obs&quot;, dist.Normal(loc, 1), obs=data)n”,
“n”,
“data = torch.randn(10)n”,
“LocalModel()(data)n”,
“GlobalModel()(data)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## How to create a complex nested <cite>PyroModule</cite> &lt;a class=&quot;anchor&quot; id=&quot;How-to-create-a-complex-nested-PyroModule&quot;&gt;&lt;/a&gt;n”,
“n”,
“To perform inference with the above <cite>BayesianLinear</cite> module we’ll need to wrap it in probabilistic model with a likelihood; that wrapper will also be a <cite>PyroModule</cite>.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 12,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“class Model(PyroModule):n”,
”    def __init__(self, in_size, out_size):n”,
”        super().__init__()n”,
”        self.linear = BayesianLinear(in_size, out_size)  # this is a PyroModulen”,
”        self.obs_scale = PyroSample(dist.LogNormal(0, 1))n”,
“n”,
”    def forward(self, input, output=None):n”,
”        obs_loc = self.linear(input)  # this samples linear.bias and linear.weightn”,
”        obs_scale = self.obs_scale    # this samples self.obs_scalen”,
”        with pyro.plate(&quot;instances&quot;, len(input)):n”,
”            return pyro.sample(&quot;obs&quot;, dist.Normal(obs_loc, obs_scale).to_event(1),n”,
”                               obs=output)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Whereas a usual <cite>nn.Module</cite> can be trained with a simple PyTorch optimizer, a Pyro model requires probabilistic inference, e.g. using [SVI](<a class="reference external" href="http://docs.pyro.ai/en/stable/inference_algos.html#pyro.infer.svi.SVI">http://docs.pyro.ai/en/stable/inference_algos.html#pyro.infer.svi.SVI</a>) and an [AutoNormal](<a class="reference external" href="http://docs.pyro.ai/en/stable/infer.autoguide.html#pyro.infer.autoguide.AutoNormal">http://docs.pyro.ai/en/stable/infer.autoguide.html#pyro.infer.autoguide.AutoNormal</a>) guide. See the [bayesian regression tutorial](<a class="reference external" href="http://pyro.ai/examples/bayesian_regression.html">http://pyro.ai/examples/bayesian_regression.html</a>) for details.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 13,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“step 0 loss = 7.186n”,
“step 100 loss = 2.185n”,
“step 200 loss = 1.87n”,
“step 300 loss = 1.739n”,
“step 400 loss = 1.691n”,
“step 500 loss = 1.673n”,
“CPU times: user 2.35 s, sys: 24.8 ms, total: 2.38 sn”,
“Wall time: 2.39 sn”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“%%timen”,
“pyro.clear_param_store()n”,
“pyro.set_rng_seed(1)n”,
“n”,
“model = Model(5, 2)n”,
“x = torch.randn(100, 5)n”,
“y = model(x)n”,
“n”,
“guide = AutoNormal(model)n”,
“svi = SVI(model, guide, Adam({&quot;lr&quot;: 0.01}), Trace_ELBO())n”,
“for step in range(2 if smoke_test else 501):n”,
”    loss = svi.step(x, y) / y.numel()n”,
”    if step % 100 == 0:n”,
”        print(&quot;step {} loss = {:0.4g}&quot;.format(step, loss))”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“<cite>PyroSample</cite> statements may also depend on other sample statements or parameters. In this case the <cite>prior</cite> can be a callable depending on <cite>self</cite>, rather than a constant distribution. For example consider the hierarchical model”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 14,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><dl>
<dt>“data”: {</dt><dd><dl class="simple">
<dt>“text/plain”: [</dt><dd><p>“tensor(0.5387)”</p>
</dd>
</dl>
<p>]</p>
</dd>
</dl>
<p>},
“execution_count”: 14,
“metadata”: {},
“output_type”: “execute_result”</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“class Model(PyroModule):n”,
”    def __init__(self):n”,
”        super().__init__()n”,
”        self.dof = PyroSample(dist.Gamma(3, 1))n”,
”        self.loc = PyroSample(dist.Normal(0, 1))n”,
”        self.scale = PyroSample(lambda self: dist.InverseGamma(self.dof, 1))n”,
”        self.x = PyroSample(lambda self: dist.Normal(self.loc, self.scale))n”,
”        n”,
”    def forward(self):n”,
”        return self.xn”,
”    n”,
“Model()()”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## How naming works  &lt;a class=&quot;anchor&quot; id=&quot;How-naming-works&quot;&gt;&lt;/a&gt;n”,
“n”,
“In the above code we saw a <cite>BayesianLinear</cite> model embedded inside another <cite>Model</cite>. Both were <cite>PyroModule`s. Whereas simple [pyro.sample](http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.sample) statements require name strings, `PyroModule</cite> attributes handle naming automatically. Let’s see how that works with the above <cite>model</cite> and <cite>guide</cite> (since <cite>AutoNormal</cite> is also a <cite>PyroModule</cite>).n”,
“n”,
“Let’s trace executions of the model and the guide.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 15,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“sample linear.bias torch.Size([2])n”,
“sample linear.weight torch.Size([5, 2])n”,
“sample obs_scale torch.Size([])n”,
“sample instances torch.Size([100])n”,
“sample obs torch.Size([100, 2])n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“with poutine.trace() as tr:n”,
”    model(x)n”,
“for site in tr.trace.nodes.values():n”,
”    print(site[&quot;type&quot;], site[&quot;name&quot;], site[&quot;value&quot;].shape)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“n”,
“Observe that <cite>model.linear.bias</cite> corresponds to the <cite>linear.bias</cite> name, and similarly for the <cite>model.linear.weight</cite> and <cite>model.obs_scale</cite> attributes. The &quot;instances&quot; site corresponds to the plate, and the &quot;obs&quot; site corresponds to the likelihood. Next examine the guide:”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: 16,
“metadata”: {},
“outputs”: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>“name”: “stdout”,
“output_type”: “stream”,
“text”: [</p>
<blockquote>
<div><p>“param AutoNormal.locs.linear.bias torch.Size([2])n”,
“param AutoNormal.scales.linear.bias torch.Size([2])n”,
“sample linear.bias_unconstrained torch.Size([2])n”,
“sample linear.bias torch.Size([2])n”,
“param AutoNormal.locs.linear.weight torch.Size([5, 2])n”,
“param AutoNormal.scales.linear.weight torch.Size([5, 2])n”,
“sample linear.weight_unconstrained torch.Size([5, 2])n”,
“sample linear.weight torch.Size([5, 2])n”,
“param AutoNormal.locs.obs_scale torch.Size([])n”,
“param AutoNormal.scales.obs_scale torch.Size([])n”,
“sample obs_scale_unconstrained torch.Size([])n”,
“sample obs_scale torch.Size([])n”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>],
“source”: [</p>
<blockquote>
<div><p>“with poutine.trace() as tr:n”,
”    guide(x)n”,
“for site in tr.trace.nodes.values():n”,
”    print(site[&quot;type&quot;], site[&quot;name&quot;], site[&quot;value&quot;].shape)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“We see the guide learns posteriors over three random variables: <cite>linear.bias</cite>, <cite>linear.weight</cite>, and <cite>obs_scale</cite>. For each of these, the guide learns a <cite>(loc,scale)</cite> pair of parameters, which are stored internally in nested <cite>PyroModules</cite>:n”,
“<code class="docutils literal notranslate"><span class="pre">`python\n&quot;,</span>
<span class="pre">&quot;class</span> <span class="pre">AutoNormal(...):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">__init__(self,</span> <span class="pre">...):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.locs</span> <span class="pre">=</span> <span class="pre">PyroModule()\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.scales</span> <span class="pre">=</span> <span class="pre">PyroModule()\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">...\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“Finally, <cite>AutoNormal</cite> contains a <cite>pyro.sample</cite> statement for each unconstrained latent site followed by a [pyro.deterministic](<a class="reference external" href="http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.deterministic">http://docs.pyro.ai/en/stable/primitives.html#pyro.primitives.deterministic</a>) statement to map the unconstrained sample to a constrained posterior sample.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## ⚠ Caution: avoiding duplicate names &lt;a class=&quot;anchor&quot; id=&quot;⚠-Caution:-avoiding-duplicate-names&quot;&gt;&lt;/a&gt;n”,
“n”,
“<cite>PyroModule`s name their attributes automatically, event for attributes nested deeply in other `PyroModule`s. However care must be taken when mixing usual `nn.Module`s with `PyroModule`s, because `nn.Module`s do not support automatic site naming.n”,
“n”,
“Within a single model (or guide):n”,
“n”,
“If there is only a single `PyroModule</cite>, then your are safe.n”,
“<code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;</span>&#160; <span class="pre">class</span> <span class="pre">Model(nn.Module):</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">not</span> <span class="pre">a</span> <span class="pre">PyroModule\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">__init__(self):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.x</span> <span class="pre">=</span> <span class="pre">PyroModule()\n&quot;,</span>
<span class="pre">&quot;-</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.y</span> <span class="pre">=</span> <span class="pre">PyroModule()</span>&#160; <span class="pre">#</span> <span class="pre">Could</span> <span class="pre">lead</span> <span class="pre">to</span> <span class="pre">name</span> <span class="pre">conflict.\n&quot;,</span>
<span class="pre">&quot;+</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.y</span> <span class="pre">=</span> <span class="pre">nn.Module()</span>&#160; <span class="pre">#</span> <span class="pre">Has</span> <span class="pre">no</span> <span class="pre">Pyro</span> <span class="pre">names,</span> <span class="pre">so</span> <span class="pre">avoids</span> <span class="pre">conflict.\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“If there are only two <cite>PyroModule`s then one must be an attribute of the other.n”,
“```diffn”,
“class Model(PyroModule):n”,
”    def __init__(self):n”,
”       self.x = PyroModule()  # okn”,
“``</cite>n”,
“If you have two <cite>PyroModule`s that are not attributes of each other, then they must be connected by attribute links through other `PyroModule`s. These can be sibling linksn”,
“```diffn”,
“- class Model(nn.Module):     # Could lead to name conflict.n”,
“+ class Model(PyroModule):    # Ensures names are unique.n”,
”      def __init__(self):n”,
”          self.x = PyroModule()n”,
”          self.y = PyroModule()n”,
“``</cite>n”,
“or ancestor linksn”,
“<code class="docutils literal notranslate"><span class="pre">`diff\n&quot;,</span>
<span class="pre">&quot;</span>&#160; <span class="pre">class</span> <span class="pre">Model(PyroModule):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">__init__(self):\n&quot;,</span>
<span class="pre">&quot;-</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.x</span> <span class="pre">=</span> <span class="pre">nn.Module()</span>&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">Could</span> <span class="pre">lead</span> <span class="pre">to</span> <span class="pre">name</span> <span class="pre">conflict.\n&quot;,</span>
<span class="pre">&quot;+</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.x</span> <span class="pre">=</span> <span class="pre">PyroModule()</span>&#160;&#160; <span class="pre">#</span> <span class="pre">Ensures</span> <span class="pre">y</span> <span class="pre">is</span> <span class="pre">conected</span> <span class="pre">to</span> <span class="pre">root</span> <span class="pre">Model.\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.x.y</span> <span class="pre">=</span> <span class="pre">PyroModule()\n&quot;,</span>
<span class="pre">&quot;`</span></code>n”,
“n”,
“Sometimes you may want to store a <cite>(model,guide)</cite> pair in a single <cite>nn.Module</cite>, e.g. to serve them from C++. In this case it is safe to make them attributes of a container <cite>nn.Module</cite>, but that container should <em>not</em> be a <cite>PyroModule</cite>.n”,
“<code class="docutils literal notranslate"><span class="pre">`python\n&quot;,</span>
<span class="pre">&quot;class</span> <span class="pre">Container(nn.Module):</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">This</span> <span class="pre">cannot</span> <span class="pre">be</span> <span class="pre">a</span> <span class="pre">PyroModule.\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">__init__(self,</span> <span class="pre">model,</span> <span class="pre">guide):</span>&#160; <span class="pre">#</span> <span class="pre">These</span> <span class="pre">may</span> <span class="pre">be</span> <span class="pre">PyroModules.\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">super().__init__()\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.model</span> <span class="pre">=</span> <span class="pre">model\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">self.guide</span> <span class="pre">=</span> <span class="pre">guide\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">This</span> <span class="pre">is</span> <span class="pre">a</span> <span class="pre">typical</span> <span class="pre">trace-replay</span> <span class="pre">pattern</span> <span class="pre">seen</span> <span class="pre">in</span> <span class="pre">model</span> <span class="pre">serving.\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160; <span class="pre">def</span> <span class="pre">forward(self,</span> <span class="pre">data):\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">tr</span> <span class="pre">=</span> <span class="pre">poutine.trace(self.guide).get_trace(data)\n&quot;,</span>
<span class="pre">&quot;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">return</span> <span class="pre">poutine.replay(model,</span> <span class="pre">tr)(data)\n&quot;,</span>
<span class="pre">&quot;`</span></code>”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: []</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>],
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“kernelspec”: {</dt><dd><p>“display_name”: “Python 3”,
“language”: “python”,
“name”: “python3”</p>
</dd>
</dl>
<p>},
“language_info”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“codemirror_mode”: {</dt><dd><p>“name”: “ipython”,
“version”: 3</p>
</dd>
</dl>
<p>},
“file_extension”: “.py”,
“mimetype”: “text/x-python”,
“name”: “python”,
“nbconvert_exporter”: “python”,
“pygments_lexer”: “ipython3”,
“version”: “3.6.10”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>},
“nbformat”: 4,
“nbformat_minor”: 4</p>
</dd>
</dl>
<p>}</p>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tensor_shapes.html" class="btn btn-neutral float-left" title="&lt;no title&gt;" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="workflow.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Pyro Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>