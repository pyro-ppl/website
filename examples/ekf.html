<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&lt;no title&gt; &mdash; Pyro Tutorials 1.8.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example: analyzing baseball stats with MCMC" href="baseball.html" />
    <link rel="prev" title="&lt;no title&gt;" href="tracking_1d.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.8.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Practical Pyro and PyTorch</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="svi_horovod.html">Example: distributed training via Horovod</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep Generative Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cevae.html">Example: Causal Effect VAE</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_gamma.html">Example: Sparse Gamma Deep Exponential Family</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Discrete Latent Variables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="toy_mixture_model_discrete_enumeration.html">Example: Toy Mixture Model With Discrete Enumeration</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm.html">Example: Hidden Markov Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="capture_recapture.html">Example: Capture-Recapture Models (CJS Models)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixed_hmm.html">Example: hierarchical mixed-effect hidden Markov models</a></li>
<li class="toctree-l1"><a class="reference internal" href="einsum.html">Example: Discrete Factor Graph Inference with Plated Einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="lda.html">Example: Amortized Latent Dirichlet Allocation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Customizing Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="neutra.html">Example: Neural MCMC with NeuTraReparam</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_regression.html">Example: Sparse Bayesian Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoname_examples.html">Example: reducing boilerplate with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.autoname</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Time Series</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="forecast_simple.html">Multivariate Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries.html">Example: Gaussian Process Time Series Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Gaussian Processes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dkl.html">Example: Deep Kernel Learning</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Epidemiology</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="epi_sir.html">Example: Univariate epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="epi_regional.html">Example: Regional epidemiological models</a></li>
<li class="toctree-l1"><a class="reference internal" href="sir_hmc.html">Example: Epidemiological inference via HMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application: Biological sequences</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mue_profile.html">Example: Constant + MuE (Profile HMM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mue_factor.html">Example: Probabilistic PCA + MuE (FactorMuE)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Inference Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="baseball.html">Example: analyzing baseball stats with MCMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcmc.html">Example: Inference with Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="lkj.html">Example: MCMC with an LKJ prior over covariances</a></li>
<li class="toctree-l1"><a class="reference internal" href="smcfilter.html">Example: Sequential Monte Carlo Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="inclined_plane.html">Example: importance sampling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Understanding Pyro's Internals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="minipyro.html">Mini-Pyro</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm_funsor.html">Example: hidden Markov models with <code class="docutils literal notranslate"><span class="pre">pyro.contrib.funsor</span></code> and <code class="docutils literal notranslate"><span class="pre">pyroapi</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pyro Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/ekf.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<dl>
<dt>{</dt><dd><dl>
<dt>“cells”: [</dt><dd><dl>
<dt>{</dt><dd><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Kalman Filtern”,
“n”,
“Kalman filters are linear models for state estimation of dynamic systems [1].  They have been the &lt;i&gt;de facto&lt;/i&gt; standard in many robotics and tracking/prediction applications because they are well suited for systems with uncertainty about an observable dynamic process.  They use a &quot;observe, predict, correct&quot; paradigm to extract information from an otherwise noisy signal. In Pyro, we can build differentiable Kalman filters with learnable parameters using the <cite>pyro.contrib.tracking</cite> [library](<a class="reference external" href="http://docs.pyro.ai/en/dev/contrib.tracking.html#module-pyro.contrib.tracking.extended_kalman_filter)n">http://docs.pyro.ai/en/dev/contrib.tracking.html#module-pyro.contrib.tracking.extended_kalman_filter)n</a>”,
“n”,
“## Dynamic processn”,
“n”,
“To start, consider this simple motion model:n”,
“n”,
“$$ X_{k+1} = FX_k + \mathbf{W}_k $$n”,
“$$ \mathbf{Z}_k = HX_k + \mathbf{V}_k $$n”,
“n”,
“where $k$ is the state, $X$ is the signal estimate, $Z_k$ is the observed value at timestep $k$, $\mathbf{W}_k$ and  $\mathbf{V}_k$ are independent noise processes (ie $\mathbb{E}[w_k v_j^T] = 0$ for all $j, k$) which we’ll approximate as Gaussians. Note that the state transitions are linear.”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## Kalman Updaten”,
“At each time step, we perform a prediction for the mean and covariance:n”,
“$$ \hat{X}_k = F\hat{X}_{k-1}$$n”,
“$$\hat{P}_k = FP_{k-1}F^T + Q$$n”,
“n”,
“and a correction for the measurement:n”,
“n”,
“$$ K_k = \hat{P}_k H^T(H\hat{P}_k H^T + R)^{-1}$$n”,
“$$ X_k = \hat{X}_k + K_k(z_k - H\hat{X}_k)$$n”,
“$$ P_k = (I-K_k H)\hat{P}_k$$n”,
“n”,
“where $X$ is the position estimate, $P$ is the covariance matrix, $K$ is the Kalman Gain, and $Q$ and $R$ are covariance matrices.n”,
“n”,
“For an in-depth derivation, see \[2\]”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## Nonlinear Estimation: Extended Kalman Filtern”,
“n”,
“What if our system is non-linear, eg in GPS navigation?  Consider the following non-linear system:n”,
“n”,
“$$ X_{k+1} = \mathbf{f}(X_k) + \mathbf{W}_k $$n”,
“$$ \mathbf{Z}_k = \mathbf{h}(X_k) + \mathbf{V}_k $$n”,
“n”,
“Notice that $\mathbf{f}$ and $\mathbf{h}$ are now (smooth) non-linear functions.n”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“The Extended Kalman Filter (EKF) attacks this problem by using a local linearization of the Kalman filter via a [Taylors Series expansion](<a class="reference external" href="https://en.wikipedia.org/wiki/Taylor_series).n">https://en.wikipedia.org/wiki/Taylor_series).n</a>”,
“n”,
“$$ f(X_k, k) \approx f(x_k^R, k) + \mathbf{H}_k(X_k - x_k^R) + \cdots$$n”,
“n”,
“where $\mathbf{H}_k$ is the Jacobian matrix at time $k$, $x_k^R$ is the previous optimal estimate, and we ignore the higher order terms.  At each time step, we compute a Jacobian conditioned the previous predictions (this computation is handled by Pyro under the hood), and use the result to perform a prediction and update.n”,
“n”,
“Omitting the derivations, the modification to the above predictions are now:n”,
“$$ \hat{X}_k \approx \mathbf{f}(X_{k-1}^R)$$n”,
“$$ \hat{P}_k = \mathbf{H}_\mathbf{f}(X_{k-1})P_{k-1}\mathbf{H}_\mathbf{f}^T(X_{k-1}) + Q$$n”,
“n”,
“and the updates are now:n”,
“n”,
“$$ X_k \approx \hat{X}_k + K_k\big(z_k - \mathbf{h}(\hat{X}_k)\big)$$n”,
“$$ K_k = \hat{P}_k \mathbf{H}_\mathbf{h}(\hat{X}_k) \Big(\mathbf{H}_\mathbf{h}(\hat{X}_k)\hat{P}_k \mathbf{H}_\mathbf{h}(\hat{X}_k) + R_k\Big)^{-1} $$n”,
“$$ P_k = \big(I - K_k \mathbf{H}_\mathbf{h}(\hat{X}_k)\big)\hat{P}_K$$n”,
“n”,
“In Pyro, all we need to do is create an <cite>EKFState</cite> object and use its <cite>predict</cite> and <cite>update</cite> methods. Pyro will do exact inference to compute the innovations and we will use SVI to learn a MAP estimate of the position and measurement covariances.n”,
“n”,
“As an example, let’s look at an object moving at near-constant velocity in 2-D in a discrete time space over 100 time steps.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“import osn”,
“import mathn”,
“n”,
“import torchn”,
“import pyron”,
“import pyro.distributions as distn”,
“from pyro.infer.autoguide import AutoDeltan”,
“from pyro.optim import Adamn”,
“from pyro.infer import SVI, Trace_ELBO, config_enumeraten”,
“from pyro.contrib.tracking.extended_kalman_filter import EKFStaten”,
“from pyro.contrib.tracking.distributions import EKFDistributionn”,
“from pyro.contrib.tracking.dynamic_models import NcvContinuousn”,
“from pyro.contrib.tracking.measurements import PositionMeasurementn”,
“n”,
“smoke_test = (‘CI’ in os.environ)n”,
“assert pyro.__version__.startswith(‘1.8.1’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“dt = 1e-2n”,
“num_frames = 10n”,
“dim = 4n”,
“n”,
“# Continuous modeln”,
“ncv = NcvContinuous(dim, 2.0)n”,
“n”,
“# Truth trajectoryn”,
“xs_truth = torch.zeros(num_frames, dim)n”,
“# initial directionn”,
“theta0_truth = 0.0n”,
“# initial staten”,
“with torch.no_grad():n”,
”    xs_truth[0, :] = torch.tensor([0.0, 0.0,  math.cos(theta0_truth), math.sin(theta0_truth)])n”,
”    for frame_num in range(1, num_frames):n”,
”        # sample independent process noisen”,
”        dx = pyro.sample(‘process_noise_{}’.format(frame_num), ncv.process_noise_dist(dt))n”,
”        xs_truth[frame_num, :] = ncv(xs_truth[frame_num-1, :], dt=dt) + dx”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Next, let’s specify the measurements. Notice that we only measure the positions of the particle.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# Measurementsn”,
“measurements = []n”,
“mean = torch.zeros(2)n”,
“# no correlationsn”,
“cov = 1e-5 * torch.eye(2)n”,
“with torch.no_grad():n”,
”    # sample independent measurement noisen”,
”    dzs = pyro.sample(‘dzs’, dist.MultivariateNormal(mean, cov).expand((num_frames,)))n”,
”    # compute measurement meansn”,
”    zs = xs_truth[:, :2] + dzs”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“We’ll use a [Delta autoguide](<a class="reference external" href="http://docs.pyro.ai/en/dev/infer.autoguide.html#autodelta">http://docs.pyro.ai/en/dev/infer.autoguide.html#autodelta</a>) to learn MAP estimates of the position and measurement covariances. The <cite>EKFDistribution</cite> computes the joint log density of all of the EKF states given a tensor of sequential measurements.”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“def model(data):n”,
”    # a HalfNormal can be used here as welln”,
”    R = pyro.sample(‘pv_cov’, dist.HalfCauchy(2e-6)) * torch.eye(4)n”,
”    Q = pyro.sample(‘measurement_cov’, dist.HalfCauchy(1e-6)) * torch.eye(2)n”,
”    # observe the measurementsn”,
”    pyro.sample(‘track_{}’.format(i), EKFDistribution(xs_truth[0], R, ncv,n”,
”                                                      Q, time_steps=num_frames),n”,
”                obs=data)n”,
”    n”,
“guide = AutoDelta(model)  # MAP estimation”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“optim = pyro.optim.Adam({‘lr’: 2e-2})n”,
“svi = SVI(model, guide, optim, loss=Trace_ELBO(retain_graph=True))n”,
“n”,
“pyro.set_rng_seed(0)n”,
“pyro.clear_param_store()n”,
“n”,
“for i in range(250 if not smoke_test else 2):n”,
”    loss = svi.step(zs)n”,
”    if not i % 10:n”,
”        print(‘loss: ‘, loss)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# retrieve states for visualizationn”,
“R = guide()[‘pv_cov’] * torch.eye(4)n”,
“Q = guide()[‘measurement_cov’] * torch.eye(2)n”,
“ekf_dist = EKFDistribution(xs_truth[0], R, ncv, Q, time_steps=num_frames)n”,
“states= ekf_dist.filter_states(zs)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “raw”,
“metadata”: {</p>
<blockquote>
<div><p>“raw_mimetype”: “text/html”</p>
</div></blockquote>
<p>},
“source”: [</p>
<blockquote>
<div><p>“&lt;center&gt;&lt;figure&gt;n”,
”    &lt;table&gt;n”,
”        &lt;tr&gt;n”,
”            &lt;td&gt; n”,
”                &lt;img src=&quot;_static/img/ekf_track.png&quot; style=&quot;width: 900px;&quot;&gt;n”,
”            &lt;/td&gt;n”,
”        &lt;/tr&gt;n”,
”    &lt;/table&gt; &lt;center&gt;n”,
”    &lt;figcaption&gt; n”,
”        &lt;font size=&quot;+1&quot;&gt;&lt;b&gt;Figure 1:&lt;/b&gt;True track and EKF prediction with error. &lt;/font&gt; n”,
”    &lt;/figcaption&gt; &lt;/center&gt;n”,
“&lt;/figure&gt;&lt;/center&gt;”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## Referencesn”,
“n”,
“\[1\] Kalman, R. E. <em>A New Approach to Linear Filtering and Prediction Problems.</em> 1960n”,
“n”,
“\[2\] Welch, Greg, and Bishop, Gary. <em>An Introduction to the Kalman Filter.</em> 2006.n”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>],
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“kernelspec”: {</dt><dd><p>“display_name”: “Python 3”,
“language”: “python”,
“name”: “python3”</p>
</dd>
</dl>
<p>},
“language_info”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“codemirror_mode”: {</dt><dd><p>“name”: “ipython”,
“version”: 3</p>
</dd>
</dl>
<p>},
“file_extension”: “.py”,
“mimetype”: “text/x-python”,
“name”: “python”,
“nbconvert_exporter”: “python”,
“pygments_lexer”: “ipython3”,
“version”: “3.6.10”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>},
“nbformat”: 4,
“nbformat_minor”: 2</p>
</dd>
</dl>
<p>}</p>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tracking_1d.html" class="btn btn-neutral float-left" title="&lt;no title&gt;" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="baseball.html" class="btn btn-neutral float-right" title="Example: analyzing baseball stats with MCMC" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Pyro Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>