

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Time Series Forecasting &mdash; Numpyro Tutorials 0.2.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/pyro.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Bayesian Neural Network" href="bnn.html" />
    <link rel="prev" title="Bayesian Regression Using NumPyro" href="bayesian_regression.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Numpyro Tutorials
          

          
            
            <img src="_static/pyro_logo_wide.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Examples:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bayesian_regression.html">Bayesian Regression Using NumPyro</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Time Series Forecasting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Data">Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model">Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Inference">Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Forecasting">Forecasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Acknowledgements">Acknowledgements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Code Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bnn.html">Bayesian Neural Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="gp.html">Gaussian Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="ucbadmit.html">Generalized Linear Mixed Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="baseball.html">Baseball</a></li>
<li class="toctree-l1"><a class="reference internal" href="hmm.html">Hidden Markov Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="stochastic_volatility.html">Stochastic Volatility</a></li>
<li class="toctree-l1"><a class="reference internal" href="vae.html">Variational Autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="funnel.html">Neal’s Funnel</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_regression.html">Sparse Regression</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Numpyro Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Time Series Forecasting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/time_series_forecasting.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Time-Series-Forecasting">
<h1>Time Series Forecasting<a class="headerlink" href="#Time-Series-Forecasting" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we will demonstrate how to build a model for time series forecasting in NumPyro. Specifically, we will replicate the <strong>Seasonal, Global Trend (SGT)</strong> model from the <a class="reference external" href="https://cran.r-project.org/web/packages/Rlgt/index.html">Rlgt: Bayesian Exponential Smoothing Models with Trend Modifications</a> package. The time series data that we will use for this tutorial is the <strong>lynx</strong> dataset, which contains annual numbers of lynx trappings from 1821 to 1934 in Canada.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">vmap</span>
<span class="kn">from</span> <span class="nn">jax.nn</span> <span class="kn">import</span> <span class="n">softmax</span>

<span class="kn">import</span> <span class="nn">numpyro</span><span class="p">;</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">set_host_device_count</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="kn">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.diagnostics</span> <span class="kn">import</span> <span class="n">autocorrelation</span><span class="p">,</span> <span class="n">hpdi</span>
<span class="kn">from</span> <span class="nn">numpyro</span> <span class="kn">import</span> <span class="n">handlers</span>
<span class="kn">from</span> <span class="nn">numpyro.infer</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;svg&#39;

<span class="k">assert</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;0.2.1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Data">
<h2>Data<a class="headerlink" href="#Data" title="Permalink to this headline">¶</a></h2>
<p>First, lets import and take a look at the dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/vincentarelbundock/Rdatasets/master/csv/datasets/lynx.csv&quot;</span>
<span class="n">lynx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Length of time series:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Length of time series: 114
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/time_series_forecasting_5_1.svg" src="_images/time_series_forecasting_5_1.svg" /></div>
</div>
<p>The time series has a length of 114 (a data point for each year), and by looking at the plot, we can observe <a class="reference external" href="https://en.wikipedia.org/wiki/Seasonality">seasonality</a> in this dataset, which is the recurrence of similar patterns at specific time periods. e.g. in this dataset, we observe a cyclical pattern every 10 years, but there is also a less obvious but clear spike in the number of trappings every 40 years. Let us see if we can model this effect in NumPyro.</p>
<p>In this tutorial, we will use the first 80 values for training and the last 34 values for testing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">80</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">80</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Model">
<h2>Model<a class="headerlink" href="#Model" title="Permalink to this headline">¶</a></h2>
<p>The model we are going to use is called <strong>Seasonal, Global Trend</strong>, which when tested on 3003 time series of the <a class="reference external" href="https://forecasters.org/resources/time-series-data/m3-competition/">M-3 competition</a>, has been known to outperform other models originally participating in the competition:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\text{exp_val}_{t} &amp;= \text{level}_{t-1} + \text{coef_trend} \times \text{level}_{t-1}^{\text{pow_trend}} + \text{s}_t \times \text{level}_{t-1}^{\text{pow_season}}, \\
\sigma_{t} &amp;= \sigma \times \text{exp_val}_{t}^{\text{powx}} + \text{offset}, \\
y_{t} &amp;\sim \text{StudentT}(\nu, \text{exp_val}_{t}, \sigma_{t})
\end{align}\end{split}\]</div>
<p>, where <code class="docutils literal notranslate"><span class="pre">level</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> follows the following recursion rules:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\text{level_p} &amp;=
\begin{cases}
y_t - \text{s}_t \times \text{level}_{t-1}^{\text{pow_season}} &amp; \text{if } t \le \text{seasonality}, \\
\text{Average} \left[y(t - \text{seasonality} + 1), \ldots, y(t)\right] &amp; \text{otherwise},
\end{cases} \\
\text{level}_{t} &amp;= \text{level_sm} \times \text{level_p} + (1 - \text{level_sm}) \times \text{level}_{t-1}, \\
\text{s}_{t + \text{seasonality}} &amp;= \text{s_sm} \times \frac{y_{t} - \text{level}_{t}}{\text{level}_{t-1}^{\text{pow_trend}}}
+ (1 - \text{s_sm}) \times \text{s}_{t}.
\end{align}\end{split}\]</div>
<p>A more detailed explanation for SGT model can be found in <a class="reference external" href="https://cran.r-project.org/web/packages/Rlgt/vignettes/GT_models.html">this vignette</a> from the authors of the Rlgt package. Here we summarize the core ideas of this model:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Student%27s_t-distribution">Student’s t-distribution</a>, which has heavier tails than normal distribution, is used for the likelihood.</p></li>
<li><p>The expected value <code class="docutils literal notranslate"><span class="pre">exp_val</span></code> consists of a trending component and a seasonal component:</p>
<ul>
<li><p>The trend is governed by the map <span class="math notranslate nohighlight">\(x \mapsto x + ax^b\)</span>, where <span class="math notranslate nohighlight">\(x\)</span> is <code class="docutils literal notranslate"><span class="pre">level</span></code>, <span class="math notranslate nohighlight">\(a\)</span> is <code class="docutils literal notranslate"><span class="pre">coef_trend</span></code>, and <span class="math notranslate nohighlight">\(b\)</span> is <code class="docutils literal notranslate"><span class="pre">pow_trend</span></code>. Note that when <span class="math notranslate nohighlight">\(b \sim 0\)</span>, the trend is linear with <span class="math notranslate nohighlight">\(a\)</span> is the slope, and when <span class="math notranslate nohighlight">\(b \sim 1\)</span>, the trend is exponential with <span class="math notranslate nohighlight">\(a\)</span> is the rate. So that function can cover a large family of trend.</p></li>
<li><p>When time changes, <code class="docutils literal notranslate"><span class="pre">level</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> are updated to new values. Coefficients <code class="docutils literal notranslate"><span class="pre">level_sm</span></code> and <code class="docutils literal notranslate"><span class="pre">s_sm</span></code> are used to make the transition smoothly.</p></li>
</ul>
</li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">powx</span></code> is near <span class="math notranslate nohighlight">\(0\)</span>, the error <span class="math notranslate nohighlight">\(\sigma_t\)</span> will be nearly constant while when <code class="docutils literal notranslate"><span class="pre">powx</span></code> is near <span class="math notranslate nohighlight">\(1\)</span>, the error will be propotional to the expected value.</p></li>
<li><p>There are several varieties of SGT. In this tutorial, we use generalized seasonality and seasonal average method.</p></li>
</ul>
<p>Note that <code class="docutils literal notranslate"><span class="pre">level</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> are updated recursively while we collect the expected value at each time step. NumPyro uses <a class="reference external" href="https://github.com/google/jax">JAX</a> in the backend to JIT compile many critical parts of the NUTS algorithm, including the verlet integrator and the tree building process. However, doing so using Python’s <code class="docutils literal notranslate"><span class="pre">for</span></code> loop in the model will result in a long compilation time for the model, so we use <code class="docutils literal notranslate"><span class="pre">jax.lax.scan</span></code> instead. A detailed explanation for using this utility can be
found in <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.lax.scan.html#jax.lax.scan">lax.scan documentation</a>. Here we use it to collect expected values while the pair <code class="docutils literal notranslate"><span class="pre">(level,</span> <span class="pre">s)</span></code> plays the role of carrying state.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">scan_exp_val</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">init_s</span><span class="p">,</span> <span class="n">level_sm</span><span class="p">,</span> <span class="n">s_sm</span><span class="p">,</span> <span class="n">coef_trend</span><span class="p">,</span> <span class="n">pow_trend</span><span class="p">,</span> <span class="n">pow_season</span><span class="p">):</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="n">init_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">scan_fn</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">pow_season</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="n">coef_trend</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">pow_trend</span> <span class="o">+</span> <span class="n">season</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">exp_val</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">moving_sum</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">seasonality</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">level_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">moving_sum</span> <span class="o">/</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">season</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">level_sm</span> <span class="o">*</span> <span class="n">level_p</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level_sm</span><span class="p">)</span> <span class="o">*</span> <span class="n">level</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_sm</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">season</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s_sm</span><span class="p">))</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">new_s</span><span class="p">[</span><span class="bp">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">moving_sum</span><span class="p">),</span> <span class="n">exp_val</span>

    <span class="n">level_init</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">init_s</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">init_s</span><span class="p">[:</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">level_init</span>
    <span class="p">(</span><span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span><span class="p">,</span> <span class="n">moving_sum</span><span class="p">),</span> <span class="n">exp_vals</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">scan_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">level_init</span><span class="p">,</span> <span class="n">s_init</span><span class="p">,</span> <span class="n">moving_sum</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">exp_vals</span><span class="p">,</span> <span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span>
</pre></div>
</div>
</div>
<p>With our utility function defined above, we are ready to specify the model using <em>NumPyro</em> primitives. In NumPyro, we use the primitive <code class="docutils literal notranslate"><span class="pre">sample(name,</span> <span class="pre">prior)</span></code> to declare a latent random variable with a corresponding <code class="docutils literal notranslate"><span class="pre">prior</span></code>. These primitives can have custom interpretations depending on the effect handlers that are used by NumPyro inference algorithms in the backend. e.g. we can condition on specific values using the <code class="docutils literal notranslate"><span class="pre">substitute</span></code> handler, or record values at these sample sites in the
execution trace using the <code class="docutils literal notranslate"><span class="pre">trace</span></code> handler. Note that these details are not important for specifying the model, or running inference, but curious readers are encouraged to read the <a class="reference external" href="http://pyro.ai/examples/effect_handlers.html">tutorial on effect handlers</a> in Pyro.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">sgt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">):</span>
    <span class="c1"># heuristically, standard derivation of Cauchy prior depends on the max value of data</span>
    <span class="n">cauchy_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">150</span>

    <span class="n">nu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;nu&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">powx</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;powx&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="n">cauchy_sd</span><span class="p">))</span>
    <span class="n">offset_sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;offset_sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">TruncatedCauchy</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
                                                                       <span class="n">scale</span><span class="o">=</span><span class="n">cauchy_sd</span><span class="p">))</span>

    <span class="n">coef_trend</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;coef_trend&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Cauchy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cauchy_sd</span><span class="p">))</span>
    <span class="n">pow_trend_beta</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pow_trend_beta&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># pow_trend takes values from -0.5 to 1</span>
    <span class="n">pow_trend</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">pow_trend_beta</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="n">pow_season</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;pow_season&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">level_sm</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;level_sm&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">s_sm</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;s_sm&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">init_s</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;init_s&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Cauchy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">[:</span><span class="n">seasonality</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">))</span>

    <span class="n">exp_val</span><span class="p">,</span> <span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span> <span class="o">=</span> <span class="n">scan_exp_val</span><span class="p">(</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">init_s</span><span class="p">,</span> <span class="n">level_sm</span><span class="p">,</span> <span class="n">s_sm</span><span class="p">,</span> <span class="n">coef_trend</span><span class="p">,</span> <span class="n">pow_trend</span><span class="p">,</span> <span class="n">pow_season</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">exp_val</span> <span class="o">**</span> <span class="n">powx</span> <span class="o">+</span> <span class="n">offset_sigma</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">exp_val</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># we return last `level` and last `s` for forecasting</span>
    <span class="k">return</span> <span class="n">last_level</span><span class="p">,</span> <span class="n">last_s</span>
</pre></div>
</div>
</div>
<p>Note that all prior parameters are retrieved from <a class="reference external" href="https://github.com/cbergmeir/Rlgt/blob/master/Rlgt/R/rlgtcontrol.R">this file</a> in the original source.</p>
</div>
<div class="section" id="Inference">
<h2>Inference<a class="headerlink" href="#Inference" title="Permalink to this headline">¶</a></h2>
<p>First, we want to choose a good value for <code class="docutils literal notranslate"><span class="pre">seasonality</span></code>. Following <a class="reference external" href="https://github.com/cbergmeir/Rlgt/blob/master/Rlgt/demo/lynx.R">the demo in Rlgt</a>, we will set <code class="docutils literal notranslate"><span class="pre">seasonality=38</span></code>. Indeed, this value can be guessed by looking at the plot of the training data, where the second order seasonality effect has a periodicity around <span class="math notranslate nohighlight">\(40\)</span> years. Note that <span class="math notranslate nohighlight">\(38\)</span> is also one of the highest-autocorrelation lags.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Lag values sorted according to their autocorrelation values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">autocorrelation</span><span class="p">(</span><span class="n">y_train</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Lag values sorted according to their autocorrelation values:

[ 0 67 57 38 68  1 29 58 37 56 28 10 19 39 66 78 47 77  9 79 48 76 30 18
 20 11 46 59 69 27 55 36  2  8 40 49 17 21 75 12 65 45 31 26  7 54 35 41
 50  3 22 60 70 16 44 13  6 25 74 53 42 32 23 43 51  4 15 14 34 24  5 52
 73 64 33 71 72 61 63 62]
</pre></div></div>
</div>
<p>Now, let us run <span class="math notranslate nohighlight">\(4\)</span> MCMC chains (using the No-U-Turn Sampler algorithm) with <span class="math notranslate nohighlight">\(5000\)</span> warmup steps and <span class="math notranslate nohighlight">\(5000\)</span> sampling steps per each chain. The returned value will be a collection of <span class="math notranslate nohighlight">\(20000\)</span> samples.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">sgt</span><span class="p">)</span>
<span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">seasonality</span><span class="o">=</span><span class="mi">38</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


                      mean       std    median      5.0%     95.0%     n_eff     r_hat
      coef_trend     28.36    109.33     13.75    -96.50    151.29   2764.20      1.00
       init_s[0]     85.84    107.71     64.52    -56.27    244.16   6350.01      1.00
       init_s[1]    -21.37     70.38    -24.60   -129.36     87.29   6476.32      1.00
       init_s[2]     28.23     90.63     17.46   -109.90    168.82   8034.11      1.00
       init_s[3]    121.38    122.49    104.45    -64.41    307.98   7790.89      1.00
       init_s[4]    444.27    253.88    399.75     73.69    803.14   5425.01      1.00
       init_s[5]   1154.30    454.67   1082.10    474.81   1824.41   3323.04      1.00
       init_s[6]   1967.76    654.71   1875.68    991.57   3009.48   2508.97      1.00
       init_s[7]   3630.69   1091.43   3494.95   1942.17   5359.23   2163.04      1.00
       init_s[8]   2576.56    824.18   2465.40   1242.32   3765.52   2489.59      1.00
       init_s[9]    949.52    448.44    874.35    278.49   1578.72   4154.86      1.00
      init_s[10]     46.84    104.77     31.36   -108.52    196.83   7045.99      1.00
      init_s[11]      0.33     51.73     -1.63    -79.91     74.23   4677.82      1.00
      init_s[12]    -11.41     64.67    -12.58   -112.08     87.99   7045.24      1.00
      init_s[13]     67.82    102.62     48.88    -86.77    213.66   6894.05      1.00
      init_s[14]    331.29    254.64    279.65     -7.07    691.20   4911.24      1.00
      init_s[15]    958.97    379.11    897.11    397.58   1539.02   3593.74      1.00
      init_s[16]   1244.99    464.41   1173.42    533.33   1937.89   3028.85      1.00
      init_s[17]   1364.60    566.63   1272.27    558.66   2181.34   3294.02      1.00
      init_s[18]    610.28    306.88    558.86    172.22   1058.01   5260.91      1.00
      init_s[19]     18.12     90.42      6.50   -121.15    152.73   8773.39      1.00
      init_s[20]    -32.80     66.02    -27.80   -145.89     62.12   8010.78      1.00
      init_s[21]    -15.37     45.50     -5.29    -90.90     42.32   2738.95      1.00
      init_s[22]     -1.57     43.03     -1.71    -69.91     56.39   6246.31      1.00
      init_s[23]     38.93     84.02     25.28    -81.79    162.50   5054.23      1.00
      init_s[24]    525.13    345.44    460.70     28.97   1003.73   4487.02      1.00
      init_s[25]    925.65    452.41    844.26    269.00   1590.84   4032.84      1.00
      init_s[26]   1771.16    688.46   1662.04    747.30   2778.02   2825.21      1.00
      init_s[27]   1261.14    468.97   1192.82    557.60   1956.55   3286.92      1.00
      init_s[28]    213.69    167.78    184.25    -26.37    468.84   7015.20      1.00
      init_s[29]     -9.17     83.42    -16.21   -141.71    110.95   7638.58      1.00
      init_s[30]     -3.25     92.60    -13.25   -133.14    130.68   2646.61      1.00
      init_s[31]    -35.44     73.29    -36.46   -152.75     71.10   9199.11      1.00
      init_s[32]     -8.71     84.19    -15.67   -139.61    119.35   8349.57      1.00
      init_s[33]    112.58    135.37     91.05    -85.43    305.19   6781.17      1.00
      init_s[34]    508.20    292.01    456.43     96.94    931.00   4929.59      1.00
      init_s[35]   1056.10    444.59    978.63    394.94   1709.24   3681.42      1.00
      init_s[36]   1836.45    656.15   1739.05    837.30   2791.87   2702.09      1.00
      init_s[37]   1437.90    560.63   1346.29    606.47   2253.71   2980.41      1.00
        level_sm      0.00      0.00      0.00      0.00      0.00  15989.43      1.00
              nu     12.26      4.77     12.59      5.42     19.98  10716.04      1.00
    offset_sigma     32.67     30.96     23.77      0.01     73.17  10475.04      1.00
      pow_season      0.09      0.04      0.09      0.02      0.15   1450.96      1.00
  pow_trend_beta      0.25      0.17      0.23      0.00      0.49   5022.31      1.00
            powx      0.62      0.13      0.62      0.41      0.85   4524.98      1.00
            s_sm      0.08      0.09      0.05      0.00      0.19  11552.92      1.00
           sigma      9.79     10.35      6.73      0.39     21.01   5790.93      1.00


</pre></div></div>
</div>
</div>
<div class="section" id="Forecasting">
<h2>Forecasting<a class="headerlink" href="#Forecasting" title="Permalink to this headline">¶</a></h2>
<p>Given <code class="docutils literal notranslate"><span class="pre">samples</span></code> from <code class="docutils literal notranslate"><span class="pre">mcmc</span></code>, we want to do forecasting for the testing dataset <code class="docutils literal notranslate"><span class="pre">y_test</span></code>. First, we will make some utilities to do forecasting given a sample. Note that to retrieve the last <code class="docutils literal notranslate"><span class="pre">level</span></code> and last <code class="docutils literal notranslate"><span class="pre">s</span></code> value, we run the model forward by constraining the latent sites to a sample from the posterior using the <code class="docutils literal notranslate"><span class="pre">substitute</span></code> handler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>    <span class="n">level</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">substitute</span><span class="p">(</span><span class="n">sgt</span><span class="p">,</span> <span class="n">sample</span><span class="p">)(</span><span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">)</span>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Ref: https://github.com/cbergmeir/Rlgt/blob/master/Rlgt/R/forecast.rlgtfit.R</span>
<span class="k">def</span> <span class="nf">sgt_forecast</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">seasonality</span><span class="p">:])</span>
    <span class="n">pow_trend</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;pow_trend_beta&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="n">yfs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">seasonality</span> <span class="o">+</span> <span class="n">future</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;pow_season&quot;</span><span class="p">]</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">level</span> <span class="o">+</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;coef_trend&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">level</span> <span class="o">**</span> <span class="n">pow_trend</span> <span class="o">+</span> <span class="n">season</span>
        <span class="n">exp_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">exp_val</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp_val</span> <span class="o">**</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;powx&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;offset_sigma&quot;</span><span class="p">]</span>
        <span class="n">yf</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;yf[{}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;nu&quot;</span><span class="p">],</span> <span class="n">exp_val</span><span class="p">,</span> <span class="n">omega</span><span class="p">))</span>
        <span class="n">yf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">yf</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-30</span><span class="p">)</span>
        <span class="n">yfs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf</span>

        <span class="n">moving_sum</span> <span class="o">=</span> <span class="n">moving_sum</span> <span class="o">+</span> <span class="n">yf</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">seasonality</span><span class="p">,</span>
                                                <span class="n">yfs</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">seasonality</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">seasonality</span> <span class="o">+</span> <span class="n">t</span><span class="p">])</span>
        <span class="n">level_p</span> <span class="o">=</span> <span class="n">moving_sum</span> <span class="o">/</span> <span class="n">seasonality</span>
        <span class="n">level_tmp</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;level_sm&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">level_p</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;level_sm&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">level</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">level_tmp</span> <span class="o">&gt;</span> <span class="mf">1e-30</span><span class="p">,</span> <span class="n">level_tmp</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="c1"># s is repeated instead of being updated</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">s</span><span class="p">[:</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">):</span>
    <span class="n">level</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">sgt</span><span class="p">,</span> <span class="n">sample</span><span class="p">)(</span><span class="n">y</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">)</span>
    <span class="n">forecast_model</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">sgt_forecast</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">)</span>
    <span class="n">forecast_trace</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">forecast_model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">forecast_trace</span><span class="p">[</span><span class="s2">&quot;yf[{}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-30</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">future</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then, we can use <a class="reference external" href="https://jax.readthedocs.io/en/latest/jax.html#jax.vmap">jax.vmap</a> to get prediction given a collection of samples. This allows us to vectorize the computation across the test dataset which can be dramatically faster as compared to using for-loop to collect predictions per test data point.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rng_keys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;nu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">forecast_marginal</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">forecast</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">seasonality</span><span class="o">=</span><span class="mi">38</span><span class="p">))(</span><span class="n">rng_keys</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, let’s get sMAPE, root mean square error of the prediction, and visualize the result with the mean prediction and the 90% highest posterior density interval (HPDI).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">forecast_marginal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sMAPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">+</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">200</span>
<span class="n">msqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;sMAPE: {:.2f}, rmse: {:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sMAPE</span><span class="p">,</span> <span class="n">msqrt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sMAPE: 62.66, rmse: 1242.18
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
<span class="n">t_future</span> <span class="o">=</span> <span class="n">lynx</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">80</span><span class="p">:]</span>
<span class="n">hpd_low</span><span class="p">,</span> <span class="n">hpd_high</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">forecast_marginal</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_future</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">t_future</span><span class="p">,</span> <span class="n">hpd_low</span><span class="p">,</span> <span class="n">hpd_high</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Forecasting lynx dataset with SGT model (90% HPDI)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/time_series_forecasting_28_0.svg" src="_images/time_series_forecasting_28_0.svg" /></div>
</div>
<p>As we can observe, the model has been able to learn both the first and second order seasonality effects, i.e. a cyclical pattern with a periodicity of around 10, as well as spikes that can be seen once every 40 or so years. Moreover, we not only have point estimates for the forecast but can also use the uncertainty estimates from the model to bound our forecasts.</p>
</div>
<div class="section" id="Acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#Acknowledgements" title="Permalink to this headline">¶</a></h2>
<p>We would like to thank Slawek Smyl for many helpful resources and suggestions. Fast inference would not have been possible without the support of JAX and the XLA teams, so we would like to thank them for providing such a great open-source platform for us to build on, and for their responsiveness in dealing with our feature requests and bug reports.</p>
</div>
<div class="section" id="References">
<h2>References<a class="headerlink" href="#References" title="Permalink to this headline">¶</a></h2>
<p>[1] <code class="docutils literal notranslate"><span class="pre">Rlgt:</span> <span class="pre">Bayesian</span> <span class="pre">Exponential</span> <span class="pre">Smoothing</span> <span class="pre">Models</span> <span class="pre">with</span> <span class="pre">Trend</span> <span class="pre">Modifications</span></code>,     Slawek Smyl, Christoph Bergmeir, Erwin Wibowo, To Wang Ng, Trustees of Columbia University</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bnn.html" class="btn btn-neutral float-right" title="Bayesian Neural Network" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bayesian_regression.html" class="btn btn-neutral float-left" title="Bayesian Regression Using NumPyro" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Uber Technologies, Inc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>